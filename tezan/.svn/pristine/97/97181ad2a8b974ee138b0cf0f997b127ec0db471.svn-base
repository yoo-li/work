<?php

$starttime = $_POST['starttime'];
$endtime = $_POST['endtime'];
//$starttime = '2017-04-01';
//$endtime =  '2017-04-30';
echo '<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />';
header("Content-type:application/vnd.ms-excel");
header("Content-Disposition:filename=".'供应商结算合计表'."$starttime".'，'."$endtime".".xls");


$currentModule = 'Mall_orders';
$endtime = strtotime($endtime . "+1 day ");
$endtime = date('Y-m-d',$endtime);
//var_dump($starttime);die();
$result = XN_Query::create('YearContent')->tag('mall_orders')
    ->filter ( 'type', 'eic','mall_orders' )
//    ->filter("my.deliverytime","!=",'')
    ->filter("my.deliverytime",">=",$starttime)    //时间限制
    ->filter("my.deliverytime","<=",$endtime)    //时间限制
    ->filter ( XN_Filter::any(XN_Filter ('my.submitreturnedgoodsdatetime', '=',null),XN_Filter( 'my.submitreturnedgoodsdatetime', '>=',$endtime),XN_Filter( 'my.order_status', '>=','确认收货')))
    ->filter("my.deleted","=",'0')
//    ->end(10)
    ->execute();

foreach ($result as $k =>$v){
    $order_ids=$v->id;
    $ids.=$v->id.',';
}
$ids = explode(",",trim($ids,','));
array_unique($ids);
$ids = array_filter($ids);
//var_dump($ids);die();
$config_fields= array   (
//    '订单号'=>'mall_orders_no',
//    '购货人'=>'consignee',
//    '商品金额'=>'orderstotal',
    '邮费'=>'postage',
//    '卡券'=>'vipcardid',
//    '订单金额'=>'sumorderstotal',
//    '余额支付'=>'usemoney',
//    '实际支付'=>'paymentamount',
//    '商品总计'=>'productcount',
//    '状态'=>'order_status',
//    '支付方式'=>'payment',
//    '下单时间'=>'singletime',
//    '付款时间'=>'paymenttime',
//    '发货时间'=>'deliverytime',
//    '确认收货'=>'confirmreceipt_time',
);
//$order_detail_header= array(
//    '商品名称'=>'productname',
//    '属性'=>'property',
//    '数量'=>'quantity',
//    '销售价格'=>'shop_price',
//    '价格'=>'profit',
//    '退货数量'=>'returnamount',
//);

$jd_config_fields= array(
//    '京东订单号'=>'jdorderid',
//    '京东订单金额'=>'orderprice',
    '运费'=>'freight',
//    '订单总价'=>'freight',
//    '订单裸价'=>'ordernakedprice',

);
$jd_order_detail_header= array(
//    '京东ID'=>'skuid',
//    '京东名称'=>'name',
//    '税种'=>'tax',
//    '京东税额'=>'taxprice',
//    '不含税价'=>'nakedprice',
//    '结算价'=>'vendor_price',
//    '总价'=>'total_price',
);

//$list_result = XN_Query::create('YearContent')->tag(strtolower($currentModule))
//    ->filter ( 'type', 'eic', strtolower($currentModule) )
//    ->filter ( 'id', 'in', $ids)
//    ->begin(0)->end(-1)->execute();
//===================
//var_dump(1);die();
$list_result = XN_Query::create('YearContent')->tag('mall_orders')
    ->filter ( 'type', 'eic','mall_orders' )
    ->filter ( 'id', 'in', $ids)
    ->begin(0)->end(-1)->execute();
//=============
//var_dump($list_result);die();
$table = '<table border="1" cellspacing="0" cellpadding="0">';
$table .= '<tr>';
foreach($config_fields as $k=>$v) {
    $table .= '<td colspan="" rowspan="">';
    $table .= $k;

    $table .= '</td>';
}
//$table .= '<td colspan="" rowspan="">';
//$table .= '退货时间';
//$table .= '</td>';
//$table .= '<td colspan="" rowspan="">';
//$table .= '退款时间';
//$table .= '</td>';

foreach($jd_config_fields as $k=>$v) {
    $table .= '<td colspan="" rowspan="">';
    $table .= $k;
    $table .= '</td>';
}
//$table .= '<td colspan="" rowspan="">';
//$table .= '订单总价';
//$table .= '</td>';

foreach($order_detail_header as $k=>$v) {
    $table .= '<td colspan="" rowspan="">';
    $table .= $k;
    $table .= '</td>';
}
//$table .= '<td colspan="" rowspan="">';
//$table .= '总价';
//$table .= '</td>';
$table .= '<td colspan="" rowspan="">';
$table .= '商城税额';
$table .= '</td>';
$table .= '<td colspan="" rowspan="">';
$table .= '不含税价';
$table .= '</td>';
$table .= '<td colspan="" rowspan="">';
$table .= '税额总计';
$table .= '</td>';
$table .= '<td colspan="" rowspan="">';
$table .= '不含税总计';
$table .= '</td>';

foreach($jd_order_detail_header as $k=>$v) {
    $table .= '<td colspan="" rowspan="">';
    $table .= $k;
    $table .= '</td>';
}
$table .= '<td colspan="" rowspan="">';
$table .= '京东不含税总计';
$table .= '</td>';
$table .= '<td colspan="" rowspan="">';
$table .= '京东税额总计';
$table .= '</td>';
$table .= '<td colspan="" rowspan="">';
$table .= '京东结算总计';
$table .= '</td>';

$table .= '</tr>';

foreach($list_result as $k=>$v) {
//    echo abcdefg;
    $order_ids=$v->id;
    $orders_products=XN_Query::create("YearContent")            //有
    ->tag("mall_orders_products")
        ->filter("type","eic","mall_orders_products")
        ->filter("my.orderid",'=',$order_ids)
        ->filter("my.deleted","=",'0')
        ->end(-1)
        ->execute();

    $jd_orders_products=XN_Query::create("YearContent")      //无
    ->tag("mall_jdorders")
        ->filter("type","eic","mall_jdorders")
        ->filter("my.orderid",'=',$order_ids)
        ->filter("my.deleted","=",'0')
        ->end(-1)
        ->execute();

        $total_postage+= $v->my->postage;
//    echo $table;
//var_dump($table);die();
    $mall_reimburses=XN_Query::create("YearContent")
        ->tag("mall_reimburses")
        ->filter("type","eic","mall_reimburses")
        ->filter("my.orderid",'=',$order_ids)
        ->filter("my.deleted","=",'0')
        ->end(1)
        ->execute();                                                                //无
//    var_dump($mall_reimburses);die();
//    $table .= '<td colspan="" rowspan='.(count($orders_products)).'>';
//    $table .= $mall_reimburses[0]->published;
//    $table .= '</td>';
//    $table .= '<td colspan="" rowspan='.(count($orders_products)).'>';
//    $table .= $mall_reimburses[0]->my->returngoodsdate;
//    $table .= '</td>';
//echo $table;die;
//    foreach($jd_config_fields as $k01=>$v01) {
//        $table .= '<td colspan="" rowspan='.(count($orders_products)).'>';
//        $table .= $jd_orders_products[0]->my->$jd_config_fields[$k01];
//        $table .= '</td>';
//    }

    $orderprice = $jd_orders_products[0]->my->orderprice;
    $freight = $jd_orders_products[0]->my->freight;
    $total_freight += $jd_orders_products[0]->my->freight;
//    $table .= '<td colspan="" rowspan='.(count($orders_products)).'>';
//    $table .= $orderprice + $freight;
//    $table .= '</td>';

    foreach($orders_products as $k01=>$v01) {

//        foreach($order_detail_header as $k02=>$v02) {
//            $table .= '<td colspan="" rowspan="">';
//            $table .= $v01->my->$order_detail_header[$k02];
//            $table .= '</td>';
//        }

        $quantity = $v01->my->quantity;
        $shop_price = $v01->my->shop_price;
        $tax  = $jd_orders_skus[0]->my->tax;

//        $table .= '<td colspan="" rowspan="">';
//        $table .= $shop_price * $quantity;
//        $table .= '</td>';
        $total_shop_price += round(($shop_price/(100+$tax)) * $tax,2);
        $total_bhsj += $shop_price - round(($shop_price/(100+$tax)) * $tax,2);
        $total_sezj += round(($shop_price/(100+$tax)) * $tax,2)*$quantity;
        $total_bhzj += ($shop_price - round(($shop_price/(100+$tax)) * $tax,2))*$quantity;

        $jd_orders_skus=XN_Query::create("YearContent")
            ->tag("mall_jdorder_skus")
            ->filter("type","eic","mall_jdorder_skus")
            ->filter("my.orderid",'=',$v01->my->orderid)
            ->filter("my.productid",'=',$v01->my->productid)
            ->filter("my.deleted","=",'0')
            ->end(1)
            ->execute();

//        foreach($jd_order_detail_header as $k02=>$v02) {
//            $table .= '<td colspan="" rowspan="">';
//            $table .= $jd_orders_skus[0]->my->$jd_order_detail_header[$k02];
//            $table .= '</td>';
//        }
        $taxprice = $jd_orders_skus[0]->my->taxprice;
        $vendor_price = $jd_orders_skus[0]->my->vendor_price;
        $nakedprice = $jd_orders_skus[0]->my->nakedprice;

        $total_taxprice += $taxprice * $quantity;
        $total_nakedprice += $nakedprice * $quantity;
        $total_quantity += ($nakedprice+$taxprice) * $quantity;

//        echo $table;
    }
//    echo $table;
}
$table .= '<tr>';

$table .= '<td>';
$table .= $total_postage;
$table .= '</td>';
$table .= '<td>';
$table .= $total_freight;
$table .= '</td>';
$table .= '<td>';
$table .= $total_shop_price;
$table .= '</td>';
$table .= '<td>';
$table .= $total_bhsj;
$table .= '</td>';
$table .= '<td>';
$table .= $total_sezj;
$table .= '</td>';
$table .= '<td>';
$table .= $total_bhzj;
$table .= '</td>';
$table .= '<td>';
$table .= $total_taxprice;
$table .= '</td>';
$table .= '<td>';
$table .= $total_nakedprice;
$table .= '</td>';
$table .= '<td>';
$table .= $total_quantity;
$table .= '</td>';
$table .= '</tr>';
$table .= '</table>';

echo $table;