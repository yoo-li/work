<?phpfunction getmoduletag($module, $loadcontent){    $lowermodule = strtolower($module);    $tag = $lowermodule;    $tags = array(        'Supplier_Shops' => array('supplierid', 'profileid'),    );    foreach ($tags as $key => $module_info)    {        if ($key == $module)        {            foreach ($module_info as $tag_info)            {                $inserttag = $loadcontent->my->$tag_info;                if (isset($inserttag) && $inserttag != "")                {                    $tag .= ',' . $lowermodule . '_' . $inserttag;                }            }        }    }    return $tag;}function getUserProposalByProfileId($profileid){    $pid = '';    try    {        $users = XN_Query::create('Content')->tag('users')            ->filter('type', 'eic', 'users')            ->filter('my.profileid', '=', $profileid)            ->end(1)            ->execute();        foreach ($users as $user)        {            $pid = $user->my->reports_to_id;        }    }    catch (XN_Exception $e)    {    }    return $pid;}function getUserProposalByProfileIds($profileids){    $pids = array();    try    {        $users = XN_Query::create('Content')->tag('users')            ->filter('type', 'eic', 'users');        if (is_array($profileids))        {            $users->filter('my.profileid', 'in', $profileids);        }        else        {            $users->filter('my.profileid', '=', $profileids);        }        $users = $users->execute();        foreach ($users as $user)        {            $pids[$user->my->profileid] = $user->my->reports_to_id;        }    }    catch (XN_Exception $e)    {    }    return $pids;}function getProxyApproval($profileid){    try    {        $proxyapprovals = XN_Query::create('Content')->tag('proxyapproval')            ->filter('type', 'eic', 'proxyapproval')            ->filter('my.switch', '=', "on")            ->filter('my.proxyapproval ', '=', $profileid)            ->filter('my.startdate ', '<=', date("Y-m-d 00:00:00"))            ->filter('my.enddate ', '>=', date("Y-m-d 24:59:59"))            ->end(1)            ->execute();        if (count($proxyapprovals) > 0)        {            $proxyapproval_info = $proxyapprovals[0];            return $proxyapproval_info->my->proxyapprovalid;        }    }    catch (XN_Exception $e)    {    }    return "";}function getLeaderships($profileids,$customapprovalflow="approvalflows"){    try    {		$profile_leaderships = array();		if ($customapprovalflow=="ma_approvalflows")		{	        $ma_staffs = XN_Query::create('Content')->tag('ma_staffs')	            ->filter('type', 'eic', 'ma_staffs')				->filter('my.deleted', '=', '0')	            ->filter('my.profileid', 'in', $profileids)	            ->execute();	        if (count($ma_staffs) > 0)	        {	            $leaderships = array();	            $profile_roleids = array();	            $departmentids = array();	            foreach ($ma_staffs as $ma_staff_info)	            {	                $profile_roleids[$ma_staff_info->my->profileid] = $ma_staff_info->my->departments;	                $departmentids[] = $ma_staff_info->my->departments;	            }	            $departmentids = array_filter($departmentids);	            $departmentids = array_unique($departmentids);	            $ma_departments = XN_Content::loadMany($departmentids,'ma_departments'); 	            if (count($ma_departments) > 0)	            {	                foreach ($ma_departments as $ma_department_info)	                {	                    $leaderships[$ma_department_info->id] = $ma_department_info->my->leadership;	                }	                foreach ($profile_roleids as $profileid => $departmentid)	                {	                    if (!array_key_exists($profileid, $profile_leaderships))	                    {	                        $profile_leaderships[$profileid] = $leaderships[$departmentid];	                    }	                }	            }			}			return $profile_leaderships;		}		        $users = XN_Query::create('Content')->tag('users')            ->filter('type', 'eic', 'users')            ->filter('my.profileid', 'in', $profileids)            ->execute();        if (count($users) > 0)        {             $leaderships = array();            $profile_roleids = array();            $roleids = array();            foreach ($users as $user_info)            {                $profile_roleids[$user_info->my->profileid] = $user_info->my->roleid;                $roleids[] = $user_info->my->roleid;            }            $roleids = array_filter($roleids);            $roleids = array_unique($roleids);            $roles = XN_Query::create('Content')->tag('roles')                ->filter('type', 'eic', 'roles')                ->filter('my.roleid', 'in', $roleids)                ->execute();            if (count($roles) > 0)            {                foreach ($roles as $role_info)                {                    $leaderships[$role_info->my->roleid] = $role_info->my->leadership;                }                foreach ($profile_roleids as $profileid => $roleid)                {                    if (!array_key_exists($profileid, $profile_leaderships))                    {                        $profile_leaderships[$profileid] = $leaderships[$roleid];                    }                }            }        }        return $profile_leaderships;    }    catch (XN_Exception $e)    {    }    return "";}function getLeadership($profileid,$customapprovalflow="approvalflows"){    try    {		if ($customapprovalflow=="ma_approvalflows")		{	        $ma_staffs = XN_Query::create('Content')->tag('ma_staffs')	            ->filter('type', 'eic', 'ma_staffs')				->filter('my.deleted', '=', '0')	            ->filter('my.profileid', '=', $profileid)	            ->execute();	        if (count($ma_staffs) > 0)	        {	            $ma_staff_info = $ma_staffs[0];				$departmentid = $ma_staff_info->my->departments;	            $ma_department_info = XN_Content::load($departmentid,'ma_departments'); 	            return  $ma_department_info->my->leadership; 			} 			return '';		}		        $users = XN_Query::create('Content')->tag('users')            ->filter('type', 'eic', 'users')            ->filter('my.profileid', '=', $profileid)            ->end(1)            ->execute();        if (count($users) > 0)        {            $user_info = $users[0];            $roleid = $user_info->my->roleid;            $roles = XN_Query::create('Content')->tag('roles')                ->filter('type', 'eic', 'roles')                ->filter('my.roleid', '=', $roleid)                ->execute();            if (count($roles) > 0)            {                $role_info = $roles[0];                return $role_info->my->leadership;            }        }    }    catch (XN_Exception $e)    {    }    return "";}function getMainLeadership($profileid,$customapprovalflow="approvalflows"){    try    {		if ($customapprovalflow=="ma_approvalflows")		{	        $ma_staffs = XN_Query::create('Content')->tag('ma_staffs')	            ->filter('type', 'eic', 'ma_staffs')				->filter('my.deleted', '=', '0')	            ->filter('my.profileid', '=', $profileid)	            ->execute();	        if (count($ma_staffs) > 0)	        {	            $ma_staff_info = $ma_staffs[0];				$departmentid = $ma_staff_info->my->departments;	            $ma_department_info = XN_Content::load($departmentid,'ma_departments'); 	            return  $ma_department_info->my->mainleadership; 			} 			return '';		}        $users = XN_Query::create('Content')->tag('users')            ->filter('type', 'eic', 'users')            ->filter('my.profileid', '=', $profileid)            ->end(1)            ->execute();        if (count($users) > 0)        {            $user_info = $users[0];            $roleid = $user_info->my->roleid;            $roles = XN_Query::create('Content')->tag('roles')                ->filter('type', 'eic', 'roles')                ->filter('my.roleid', '=', $roleid)                ->end(1)                ->execute();            if (count($roles) > 0)            {                $role_info = $roles[0];                return $role_info->my->mainleadership;            }        }    }    catch (XN_Exception $e)    {    }    return "";}function getMainLeaderships($profileids,$customapprovalflow="approvalflows"){    try    {		$profile_leaderships = array();		if ($customapprovalflow=="ma_approvalflows")		{	        $ma_staffs = XN_Query::create('Content')->tag('ma_staffs')	            ->filter('type', 'eic', 'ma_staffs')				->filter('my.deleted', '=', '0')	            ->filter('my.profileid', 'in', $profileids)	            ->execute();	        if (count($ma_staffs) > 0)	        {	            $leaderships = array();	            $profile_roleids = array();	            $departmentids = array();	            foreach ($ma_staffs as $ma_staff_info)	            {	                $profile_roleids[$ma_staff_info->my->profileid] = $ma_staff_info->my->departments;	                $departmentids[] = $ma_staff_info->my->departments;	            }	            $departmentids = array_filter($departmentids);	            $departmentids = array_unique($departmentids);	            $ma_departments = XN_Content::loadMany($departmentids,'ma_departments'); 	            if (count($ma_departments) > 0)	            {	                foreach ($ma_departments as $ma_department_info)	                {	                    $leaderships[$ma_department_info->id] = $ma_department_info->my->mainleadership;	                }	                foreach ($profile_roleids as $profileid => $departmentid)	                {	                    if (!array_key_exists($profileid, $profile_leaderships))	                    {	                        $profile_leaderships[$profileid] = $leaderships[$departmentid];	                    }	                }	            }			}			return $profile_leaderships;		}        $users = XN_Query::create('Content')->tag('users')            ->filter('type', 'eic', 'users')            ->filter('my.profileid', 'in', $profileids)            ->execute();        if (count($users) > 0)        {            $profile_mianleaderships = array();            $mianleaderships = array();            $profile_roleids = array();            $roleids = array();            foreach ($users as $user_info)            {                $profile_roleids[$user_info->my->profileid] = $user_info->my->roleid;                $roleids[] = $user_info->my->roleid;            }            $roleids = array_filter($roleids);            $roleids = array_unique($roleids);            $roles = XN_Query::create('Content')->tag('roles')                ->filter('type', 'eic', 'roles')                ->filter('my.roleid', 'in', $roleids)                ->execute();            if (count($roles) > 0)            {                foreach ($roles as $role_info)                {                    $mianleaderships[$role_info->my->roleid] = $role_info->my->mainleadership;                }                foreach ($profile_roleids as $profileid => $roleid)                {                    if (!array_key_exists($profileid, $profile_mianleaderships))                    {                        $profile_mianleaderships[$profileid] = $mianleaderships[$roleid];                    }                }            }        }        return $profile_mianleaderships;    }    catch (XN_Exception $e)    {    }    return "";}/** * $userinfo=array('leadership' => $leadership,'mainleadership' => $mainleadership,'author' => $author,'report_userid' => $report_userid, 'optionalapproval' => $optionalapproval); */function getNodes($approvalflowdata, $amount, $record, $guid, $userinfo, $flowid = null){    $approvals = XN_Query::create('Content')        ->tag('approvals')        ->filter('type', 'eic', 'approvals')        ->filter('my.guid', '=', $guid)        ->filter('my.record', '=', $record)        ->execute();    $approval_userids = array();    foreach ($approvals as $approval_info)    {        $approval_userids[] = $approval_info->my->userid;    }    return getApprovalNodes($approvalflowdata, floatval($amount), $approval_userids, $userinfo, $flowid);}function checkNodes($worknode, $approval_userids, $userinfo){    if ($worknode == '000000')    {        $userid = $userinfo['report_userid'];        if (in_array($userid, $approval_userids) && $userid != "") return true;    }    else if ($worknode == '000004')    {        $userid = $userinfo['author'];        if (in_array($userid, $approval_userids) && $userid != "") return true;    }    else if ($worknode == '000001')    {        $userid = $userinfo['optionalapproval'];        if (in_array($userid, $approval_userids) && $userid != "") return true;    }    else if ($worknode == '000002')    {        $userid = $userinfo['leadership'];        if (in_array($userid, $approval_userids) && $userid != "") return true;    }    else if ($worknode == '000003')    {        $userid = $userinfo['mainleadership'];        if (in_array($userid, $approval_userids) && $userid != "") return true;    }    else    {        if (in_array($worknode, $approval_userids)) return true;    }    return false;}function checknextflowid($routes, $routeid){    foreach ($routes as $route)    {        if ($route[1] == $routeid) return $route[0];    }    return -1;}function getApprovalNodes($approvalflowdata, $amount, $approval_userids, $userinfo, $flowid = null){    if ($flowid == null)    {        $flowid = $approvalflowdata['beginnode'];    }    $arr = array();    foreach ($approvalflowdata['route'] as $route)    {        if ($route[1] == $flowid)        {            $id = $route[2];            $condition = $route[3];            $nodeamount = floatval($route[4]);            foreach ($approvalflowdata['worknode'] as $worknode)            {                if ($worknode[0] == $id && $condition == "" && $nodeamount == "")                {                    if (checkNodes($worknode[2], $approval_userids, $userinfo))                    {                        if (checknextflowid($approvalflowdata['route'], $id) != "-1")                        {                            $result = getApprovalNodes($approvalflowdata, $amount, $approval_userids, $userinfo, $id);                            $arr = $result + $arr;                        }                    }                    else                    {                        $arr[$id] = $worknode[2];                    }                }                else if ($worknode[0] == $id)                {                    //echo '_______['.$id.']__________'.$nodeamount.'____'.$amount.'______'.$condition.'_______';                    if ($condition == "=" && $nodeamount == $amount)                    {                        if (checkNodes($worknode[2], $approval_userids, $userinfo))                        {                            if (checknextflowid($approvalflowdata['route'], $id) != "-1")                            {                                $result = getApprovalNodes($approvalflowdata, $amount, $approval_userids, $userinfo, $id);                                $arr = $result + $arr;                            }                        }                        else                        {                            $arr[$id] = $worknode[2];                        }                    }                    else if ($condition == "<" && $amount < $nodeamount)                    {                        if (checkNodes($worknode[2], $approval_userids, $userinfo))                        {                            if (checknextflowid($approvalflowdata['route'], $id) != "-1")                            {                                $result = getApprovalNodes($approvalflowdata, $amount, $approval_userids, $userinfo, $id);                                $arr = $result + $arr;                            }                        }                        else                        {                            $arr[$id] = $worknode[2];                        }                    }                    else if ($condition == "<=" && $amount <= $nodeamount)                    {                        if (checkNodes($worknode[2], $approval_userids, $userinfo))                        {                            if (checknextflowid($approvalflowdata['route'], $id) != "-1")                            {                                $result = getApprovalNodes($approvalflowdata, $amount, $approval_userids, $userinfo, $id);                                $arr = $result + $arr;                            }                        }                        else                        {                            $arr[$id] = $worknode[2];                        }                    }                    else if ($condition == ">" && $amount > $nodeamount)                    {                        if (checkNodes($worknode[2], $approval_userids, $userinfo))                        {                            if (checknextflowid($approvalflowdata['route'], $id) != "-1")                            {                                $result = getApprovalNodes($approvalflowdata, $amount, $approval_userids, $userinfo, $id);                                $arr = $result + $arr;                            }                        }                        else                        {                            $arr[$id] = $worknode[2];                        }                    }                    else if ($condition == ">=" && $amount >= $nodeamount)                    {                        if (checkNodes($worknode[2], $approval_userids, $userinfo))                        {                            if (checknextflowid($approvalflowdata['route'], $id) != "-1")                            {                                $result = getApprovalNodes($approvalflowdata, $amount, $approval_userids, $userinfo, $id);                                $arr = $result + $arr;                            }                        }                        else                        {                            $arr[$id] = $worknode[2];                        }                    }                }            }        }    }    return $arr;}//自动递交审批流程function approvalprocess($recordid, $formodule, $tabid, $mode, $smarty){    $focus = XN_Content::load($recordid, strtolower($formodule));    $reports_to_msg = "";    $msg = "";	global $global_session; 	$authorize = $global_session['authorize'];          $accounting = array();    if (isset($authorize))    {        if (isset($authorize['accounting']))        {            $accounting = $authorize['accounting'];        }    }    $error = false;    try    {        switch ($focus->my->approvalstatus)        {            case 1 :            case '1' :                $msg .= getTranslatedString("LBL_APPROVALSTATUSLABEL") . getTranslatedString("LBL_APPROVALING") . "\n";                break;            case 2 :            case '2' :                $msg .= $focus->my->submitapprovaldatetime . "开始进入审批流程.\n";                break;            case 3 :            case '3' :                $msg .= $focus->my->submitapprovaldatetime . "开始进入审批流程.\n";                break;            case 4 :            case '4' :                $msg .= getTranslatedString("LBL_APPROVALSTATUSLABEL") . getTranslatedString("LBL_REAPPROVAL") . "\n";                break;            default :                $msg .= getTranslatedString("LBL_APPROVALSTATUSLABEL") . getTranslatedString("LBL_NOTSUBMITTED") . "\n";                break;        }        $approvals = XN_Query::create('Content')            ->tag('approvals')            ->filter('type', 'eic', 'approvals')            ->filter('my.tabid', '=', $tabid)            ->filter('my.deleted', '=', '0')            ->filter('my.record', '=', $recordid);        $approvals = $approvals->order('published', XN_Order::ASC)->execute();        if (count($approvals) > 0)        {            $approvaldata = array();            $current_userid = XN_Profile::$VIEWER;            $current_user_reports_to_id = getUserProposalByProfileId($current_userid);            $profilelist = array();            foreach ($approvals as $approval_info)            {                $guid = $approval_info->my->guid;                $approve = array();                $approve['reply'] = $approval_info->my->reply;                $approve['reply_text'] = $approval_info->my->reply_text;                $approve['submitreplydatetime'] = $approval_info->my->submitreplydatetime;                $approve['finished'] = $approval_info->my->finished;                $approve['userid'] = $approval_info->my->userid;                $approve['proxyapproval'] = $approval_info->my->proxyapproval;                $approve['approver'] = $approval_info->my->approver;                $approve['from_userid'] = $approval_info->my->from_userid;                $approve['published'] = $approval_info->createdDate;                $approvaldata[$guid][] = $approve;                if (!in_array($approve['userid'], $profilelist)) $profilelist[] = $approve['userid'];                if (!in_array($approve['from_userid'], $profilelist)) $profilelist[] = $approve['from_userid'];                if (!in_array($approve['proxyapproval'], $profilelist)) $profilelist[] = $approve['proxyapproval'];                if (!in_array($approve['approver'], $profilelist)) $profilelist[] = $approve['approver'];            }            $usernamelist = getUserNameList($profilelist);            $pos = 1;            foreach ($approvaldata as $guid => $approvaldata_info)            {                foreach ($approvaldata_info as $approval_info)                {                    $msg .= '[第' . $pos . '次流转]于' . $approval_info['published'] . '由' . $usernamelist[$approval_info['from_userid']] . '提交，';                    if ($approval_info['finished'] == 'true')                    {                        if ($approval_info['reply_text'] == "")                        {                            if ($approval_info['approver'] == $approval_info['userid'])                            {                                if (in_array($approval_info['userid'], $accounting))                                {                                    if ($approval_info['reply'] == "Agree")                                    {                                        $msg .= $approval_info['submitreplydatetime'] . $usernamelist[$approval_info['approver']] . '财务复核[通过]' . "。";                                    }                                    else                                    {                                        $msg .= $approval_info['submitreplydatetime'] . $usernamelist[$approval_info['approver']] . '财务复核[不通过]' . "。";                                    }                                }                                else                                {                                    $msg .= $approval_info['submitreplydatetime'] . $usernamelist[$approval_info['approver']] . '批复[' . getTranslatedString($approval_info['reply']) . ']' . "。";                                }                            }                            else                            {                                $msg .= $approval_info['submitreplydatetime'] . $usernamelist[$approval_info['approver']] . '代理【' . $usernamelist[$approval_info['userid']] . '】批复[' . getTranslatedString($approval_info['reply']) . ']' . "。";                            }                        }                        else                        {                            if ($approval_info['approver'] == $approval_info['userid'])                            {                                if (in_array($approval_info['userid'], $accounting))                                {                                    if ($approval_info['reply'] == "Agree")                                    {                                        $msg .= $approval_info['submitreplydatetime'] . $usernamelist[$approval_info['approver']] . '财务复核[通过]' . "。" . "\n审批意见：" . $approval_info['reply_text'];                                    }                                    else                                    {                                        $msg .= $approval_info['submitreplydatetime'] . $usernamelist[$approval_info['approver']] . '财务复核[不通过]' . "。" . "\n审批意见：" . $approval_info['reply_text'];                                    }                                }                                else                                {                                    $msg .= $approval_info['submitreplydatetime'] . $usernamelist[$approval_info['approver']] . '批复[' . getTranslatedString($approval_info['reply']) . ']。' . "\n审批意见：" . $approval_info['reply_text'];                                }                            }                            else                            {                                $msg .= $approval_info['submitreplydatetime'] . $usernamelist[$approval_info['approver']] . '代理【' . $usernamelist[$approval_info['userid']] . '】批复[' . getTranslatedString($approval_info['reply']) . ']。' . "\n审批意见：" . $approval_info['reply_text'];                            }                        }                    }                    else                    {                        if (in_array($approval_info['userid'], $accounting))                        {                            $msg .= $usernamelist[$approval_info['userid']] . '目前没有财务复核。';                        }                        else                        {                            $msg .= $usernamelist[$approval_info['userid']] . '目前没有批复。';                        }                    }                    $msg .= "\n";                }                $pos += 1;            }        }        switch ($focus->my->approvalstatus)        {            case 2 :            case '2' :                $msg .= $focus->my->submitapprovalreplydatetime . "结束审批,审批同意.\n";                break;            case 3 :            case '3' :                $msg .= $focus->my->submitapprovalreplydatetime . "结束审批,审批不同意.\n";                break;        }        $msg = '<div style="width:99%;height:136px">' . $reports_to_msg . '<textarea readonly rows="8"   style="width:100%;height:125px"    class="detailedViewTextBox">' . $msg . '</textarea></div>';        $msg .= '<input type="hidden" value="' . $formodule . '" name="formodule">';    }    catch (XN_Exception $e)    {        $msg .= '<p align="left"><font color="red" size="2">' . $e->getMessage() . '</font></p>';        $error = true;    }    if (isset($mode) && $mode == 'submit')    {        if ($focus->my->personman == XN_Profile::$VIEWER || $focus->author == XN_Profile::$VIEWER ||$formodule="Ma_RegisterCodes")        {            //供应商注册时走这里，后台添加时弹出对话框，确定提交，前台时不弹出对话框，直接发送请求到sendApprove            $smarty->assign("SUBMODULE", "Approvals");            $smarty->assign("SUBACTION", "sendApprove");            $approvals = XN_Query::create('Content')                ->tag('approvals')                ->filter('type', 'eic', 'approvals')                ->filter('my.tabid', '=', $tabid)                ->filter('my.deleted', '=', '0')                ->filter('my.finished', '=', 'false')                ->filter('my.record', '=', $recordid)                ->execute();            if (count($approvals) == 0)            {                $msg .= '<div style="width:100%"><font color="red" size="2">提交审批后，您将没有权限再进行修改，是否确定提交?</font></div>';                $smarty->assign("OKBUTTON", getTranslatedString('LBL_APPROVALS_SURE_BUTTON_LABEL'));            }            else            {                $msg .= '<div style="width:100%"><font color="red" size="2">您已经提交了审批！</font></div>';            }        }        else if (is_array($focus->my->personman))        {            if (in_array(XN_Profile::$VIEWER, $focus->my->personman))            {                $smarty->assign("SUBMODULE", "Approvals");                $smarty->assign("SUBACTION", "sendApprove");                $approvals = XN_Query::create('Content')                    ->tag('approvals')                    ->filter('type', 'eic', 'approvals')                    ->filter('my.tabid', '=', $tabid)                    ->filter('my.deleted', '=', '0')                    ->filter('my.finished', '=', 'false')                    ->filter('my.record', '=', $recordid)                    ->execute();                if (count($approvals) == 0)                {                    $msg .= '<div style="width:100%"><font color="red" size="2">提交审批后，您将没有权限再进行修改，是否确定提交?</font></div>';                    $smarty->assign("OKBUTTON", getTranslatedString('LBL_APPROVALS_SURE_BUTTON_LABEL'));                }                else                {                    $msg .= '<div style="width:100%"><font color="red" size="2">您已经提交了审批！</font></div>';                }            }            else            {                $msg .= '<div style="width:100%"><font color="red" size="2">您不是表单负责人，没有权限提交审批!</font></div>';            }        }        else        {            $msg .= '<div style="width:100%"><font color="red" size="2">您不是表单负责人，没有权限提交审批!</font></div>';        }    }    return $msg;}/****************************** * 提交审批 * $record:提交的记录 * $formodule:数据所在的模块名， * $destination:（front:前台提交，不自动跳转到列表页，在smarty模板制定跳转页面；back:后台提交审批，提交成功，自动跳转到列表页并刷新） ********************************/function sendapproval($record, $formodule, $destination,$customapprovalflow="approvalflows"){    $approvals = XN_Query::create('Content')        ->tag('approvals')        ->filter('type', 'eic', 'approvals')        ->filter('my.finished', '=', 'false')        ->filter('my.deleted', '=', '0')        ->filter('my.record', '=', $record)        ->execute();    if (count($approvals) > 0)    {        if ($destination == "front")        {            return;        }        if ($destination == "back")        {            redirect($formodule);            die();        }    }	global $global_session; 	$tabdata  = $global_session['tabdata'];     $approvaltabs = $tabdata['approvaltabs'];        $tabid = getTabid($formodule);    if (in_array($tabid, $approvaltabs) || $customapprovalflow != "approvalflows")    {		if ($customapprovalflow != "approvalflows")		{			global $supplierid; 	        $approvalflows = XN_Query::create('Content')	            ->tag($customapprovalflow)	            ->filter('type', 'eic', $customapprovalflow)	            ->filter('my.approvalflowsstatus', '=', '1')				->filter('my.supplierid', '=', $supplierid)	            ->filter('my.deleted', '=', '0')	            ->filter('my.customapprovalflowtabid', '=', $tabid)				->end(1)	            ->execute();		}		else		{	        $approvalflows = XN_Query::create('Content')	            ->tag('approvalflows')	            ->filter('type', 'eic', 'approvalflows')	            ->filter('my.approvalflowsstatus', '=', '1')	            ->filter('my.deleted', '=', '0')	            ->filter('my.tabid', '=', $tabid)				->end(1)	            ->execute();		}                $approvalflowdata = array();        if (count($approvalflows) > 0)        {            $approvalflow_info = $approvalflows[0];            $flowdata = $approvalflow_info->my->flowdata;            $amountfieldname = $approvalflow_info->my->fieldname;            $approvalinfo = $approvalflow_info->my->description;            $xml = new DOMDocument();            $xml->loadXML($flowdata);            $routedata = array();            $routes = $xml->getElementsByTagName("Route");            foreach ($routes as $route)            {                $id = $route->getAttribute("ID");                $fromelementid = $route->getAttribute("FromElementID");                $amount = $route->getAttribute("Amount");                $condition = $route->getAttribute("Condition");                $toelementid = $route->getAttribute("ToElementID");                $routedata[] = array($id, $fromelementid, $toelementid, $condition, floatval($amount));            }            $approvalflowdata['route'] = $routedata;            $worknodedata = array();            $decideapprovals = array();            $worknodes = $xml->getElementsByTagName("WorkNode");            foreach ($worknodes as $worknode)            {                $id = $worknode->getAttribute("ID");                $name = $worknode->getAttribute("Name");                $nodetype = $worknode->getAttribute("NodeType");                $decideapproval = $worknode->getAttribute("DecideApproval");                $decideapprovals[$id] = $decideapproval;                $worknodedata[] = array($id, $name, $nodetype);            }            $approvalflowdata['worknode'] = $worknodedata;            $beginnodes = $xml->getElementsByTagName("BeginNode");            foreach ($beginnodes as $beginnode)            {                $id = $beginnode->getAttribute("ID");                $approvalflowdata['beginnode'] = $id;            }        }        if (count($approvalflowdata) > 0)        {            $guid = guid();            $hasapproval = false;            $loadcontent = XN_Content::load($record, strtolower($formodule));            $amount = 0;            if ($amountfieldname != "" && $loadcontent->my->$amountfieldname != "")            {                $amount = floatval($loadcontent->my->$amountfieldname);            }            $current_userid = $loadcontent->author;            $report_userid = getUserProposalByProfileId($current_userid);            $userinfo = array('leadership'       => getLeadership($current_userid,$customapprovalflow),                              'mainleadership'   => getMainLeadership($current_userid,$customapprovalflow),                              'author'           => $loadcontent->author,                              'report_userid'    => $report_userid,                              'optionalapproval' => $loadcontent->my->optionalapproval);            $nodes = getNodes($approvalflowdata, $amount, $record, $guid, $userinfo);            foreach ($nodes as $node => $worknode)            {                if ($worknode == '000000')                {                    $approvedata = array();                    $approvedata['tabid'] = $tabid;                    $approvedata['record'] = $record;                    $approvedata['from_userid'] = XN_Profile::$VIEWER;                    $approvedata['sourcer'] = $current_userid;                    $approvedata['userid'] = $userinfo['report_userid'];                    $approvedata['proxyapproval'] = getProxyApproval($report_userid);                    $approvedata['flowid'] = $node;                    $approvedata['decideapproval'] = $decideapprovals[$node];                    $approvedata['nextflowid'] = checknextflowid($approvalflowdata['route'], $node);                    $approvedata['finished'] = 'false';                    $approvedata['guid'] = $guid;                    $approvedata['reply'] = "Approvaling";                    $approvedata['amount'] = $amount;                    $approvedata['approvalinfo'] = $approvalinfo;                    $approvedata['approvalflows'] = $approvalflow_info->id;					$approvedata['customapprovalflow'] = $customapprovalflow;                    addapprove($approvedata,1);                    $hasapproval = true;                }                else if ($worknode == '000004')                {                    $approvedata = array();                    $approvedata['tabid'] = $tabid;                    $approvedata['record'] = $record;                    $approvedata['from_userid'] = XN_Profile::$VIEWER;                    $approvedata['sourcer'] = $current_userid;                    $approvedata['userid'] = $current_userid;                    $approvedata['proxyapproval'] = getProxyApproval($current_userid);                    $approvedata['flowid'] = $node;                    $approvedata['decideapproval'] = $decideapprovals[$node];                    $approvedata['nextflowid'] = checknextflowid($approvalflowdata['route'], $node);                    $approvedata['finished'] = 'false';                    $approvedata['guid'] = $guid;                    $approvedata['reply'] = "Approvaling";                    $approvedata['amount'] = $amount;                    $approvedata['approvalinfo'] = $approvalinfo;                    $approvedata['approvalflows'] = $approvalflow_info->id;					$approvedata['customapprovalflow'] = $customapprovalflow;                    addapprove($approvedata,1);                    $hasapproval = true;                }                else if ($worknode == '000001')                {                    $optionalapproval = $userinfo['optionalapproval'];                    $approvedata = array();                    $approvedata['tabid'] = $tabid;                    $approvedata['record'] = $record;                    $approvedata['from_userid'] = XN_Profile::$VIEWER;                    $approvedata['sourcer'] = $current_userid;                    $approvedata['userid'] = $optionalapproval;                    $approvedata['proxyapproval'] = getProxyApproval($optionalapproval);                    $approvedata['flowid'] = $node;                    $approvedata['decideapproval'] = $decideapprovals[$node];                    $approvedata['nextflowid'] = checknextflowid($approvalflowdata['route'], $node);                    $approvedata['finished'] = 'false';                    $approvedata['guid'] = $guid;                    $approvedata['reply'] = "Approvaling";                    $approvedata['amount'] = $amount;                    $approvedata['approvalinfo'] = $approvalinfo;                    $approvedata['approvalflows'] = $approvalflow_info->id;					$approvedata['customapprovalflow'] = $customapprovalflow;                    addapprove($approvedata);                    $hasapproval = true;                }                else if ($worknode == '000002')                {                    $leadership = $userinfo['leadership'];;                    if (is_array($leadership))                    {                        foreach ($leadership as $leadership_info)                        {                            $approvedata = array();                            $approvedata['tabid'] = $tabid;                            $approvedata['record'] = $record;                            $approvedata['from_userid'] = XN_Profile::$VIEWER;                            $approvedata['sourcer'] = $current_userid;                            $approvedata['userid'] = $leadership_info;                            $approvedata['proxyapproval'] = getProxyApproval($leadership_info);                            $approvedata['flowid'] = $node;                            $approvedata['decideapproval'] = $decideapprovals[$node];                            $approvedata['nextflowid'] = checknextflowid($approvalflowdata['route'], $node);                            $approvedata['finished'] = 'false';                            $approvedata['guid'] = $guid;                            $approvedata['reply'] = "Approvaling";                            $approvedata['amount'] = $amount;                            $approvedata['approvalinfo'] = $approvalinfo;                            $approvedata['approvalflows'] = $approvalflow_info->id;							$approvedata['customapprovalflow'] = $customapprovalflow;                            addapprove($approvedata,1);                        }                    }                    else                    {                        $approvedata = array();                        $approvedata['tabid'] = $tabid;                        $approvedata['record'] = $record;                        $approvedata['from_userid'] = XN_Profile::$VIEWER;                        $approvedata['sourcer'] = $current_userid;                        $approvedata['userid'] = $leadership;                        $approvedata['proxyapproval'] = getProxyApproval($leadership);                        $approvedata['flowid'] = $node;                        $approvedata['decideapproval'] = $decideapprovals[$node];                        $approvedata['nextflowid'] = checknextflowid($approvalflowdata['route'], $node);                        $approvedata['finished'] = 'false';                        $approvedata['guid'] = $guid;                        $approvedata['reply'] = "Approvaling";                        $approvedata['amount'] = $amount;                        $approvedata['approvalinfo'] = $approvalinfo;                        $approvedata['approvalflows'] = $approvalflow_info->id;						$approvedata['customapprovalflow'] = $customapprovalflow;                        addapprove($approvedata,1);                    }                    $hasapproval = true;                }                else if ($worknode == '000003')                {                    $mainleadership = $userinfo['mainleadership'];                    $approvedata = array();                    $approvedata['tabid'] = $tabid;                    $approvedata['record'] = $record;                    $approvedata['from_userid'] = XN_Profile::$VIEWER;                    $approvedata['sourcer'] = $current_userid;                    $approvedata['userid'] = $mainleadership;                    $approvedata['proxyapproval'] = getProxyApproval($mainleadership);                    $approvedata['flowid'] = $node;                    $approvedata['decideapproval'] = $decideapprovals[$node];                    $approvedata['nextflowid'] = checknextflowid($approvalflowdata['route'], $node);                    $approvedata['finished'] = 'false';                    $approvedata['guid'] = $guid;                    $approvedata['reply'] = "Approvaling";                    $approvedata['amount'] = $amount;                    $approvedata['approvalinfo'] = $approvalinfo;                    $approvedata['approvalflows'] = $approvalflow_info->id;					$approvedata['customapprovalflow'] = $customapprovalflow;                    addapprove($approvedata,1);                    $hasapproval = true;                }                else if ($worknode == '000000')                {                    $approvedata = array();                    $approvedata['tabid'] = $tabid;                    $approvedata['record'] = $record;                    $approvedata['from_userid'] = XN_Profile::$VIEWER;                    $approvedata['sourcer'] = $current_userid;                    $approvedata['userid'] = $userinfo['report_userid'];                    $approvedata['proxyapproval'] = getProxyApproval($report_userid);                    $approvedata['flowid'] = $node;                    $approvedata['decideapproval'] = $decideapprovals[$node];                    $approvedata['nextflowid'] = checknextflowid($approvalflowdata['route'], $node);                    $approvedata['finished'] = 'false';                    $approvedata['guid'] = $guid;                    $approvedata['reply'] = "Approvaling";                    $approvedata['amount'] = $amount;                    $approvedata['approvalinfo'] = $approvalinfo;                    $approvedata['approvalflows'] = $approvalflow_info->id;					$approvedata['customapprovalflow'] = $customapprovalflow;                    addapprove($approvedata,1);                    $hasapproval = true;                }                else                {                    $approvedata = array();                    $approvedata['tabid'] = $tabid;                    $approvedata['record'] = $record;                    $approvedata['from_userid'] = $current_userid;                    $approvedata['sourcer'] = $current_userid;                    $approvedata['userid'] = $worknode;                    $approvedata['proxyapproval'] = getProxyApproval($worknode);                    $approvedata['flowid'] = $node;                    $approvedata['decideapproval'] = $decideapprovals[$node];                    $approvedata['nextflowid'] = checknextflowid($approvalflowdata['route'], $node);                    $approvedata['finished'] = 'false';                    $approvedata['guid'] = $guid;                    $approvedata['reply'] = "Approvaling";                    $approvedata['amount'] = $amount;                    $approvedata['approvalinfo'] = $approvalinfo;                    $approvedata['approvalflows'] = $approvalflow_info->id;					$approvedata['customapprovalflow'] = $customapprovalflow;                    addapprove($approvedata,1);                    $hasapproval = true;                }            }            if ($hasapproval)            {                $loadcontent = XN_Content::load($record, strtolower($formodule));                $loadcontent->my->approvalstatus = 1;                $status = strtolower($formodule) . 'status';                $loadcontent->my->$status = 'Approvaling';                $loadcontent->my->submitapprovaldatetime = date("Y-m-d H:i");                $loadcontent->save(strtolower($formodule));            }        }        //print_r($approvalflowdata);    }    if ($destination == "back")    {        //后台调用时默认跳转到列表页        redirect($formodule);    }    if ($destination == "front")    {        //前台调用时不跳转，使用smarty指向到模板    }}	function sendapprovals($records, $formodule, $destination,$customapprovalflow="approvalflows")	{		$approvals = XN_Query::create('Content')							 ->tag('approvals')							 ->filter('type', 'eic', 'approvals')							 ->filter('my.finished', '=', 'false')							 ->filter('my.deleted', '=', '0')							 ->filter('my.record', 'in', $records)							 ->end(-1)							 ->execute();		foreach ($approvals as $approval){			unset($records[$approval->my->record]);		}		if(count($records) <= 0)			return;		global $global_session; 		$tabdata  = $global_session['tabdata']; 		$approvaltabs = $tabdata['approvaltabs'];		 		$tabid = getTabid($formodule);		if (in_array($tabid, $approvaltabs) || $customapprovalflow != "approvalflows")		{			if ($customapprovalflow != "approvalflows")			{				global $supplierid;				$approvalflows = XN_Query::create('Content')										 ->tag($customapprovalflow)										 ->filter('type', 'eic', $customapprovalflow)										 ->filter('my.approvalflowsstatus', '=', '1')										 ->filter('my.supplierid', '=', $supplierid)										 ->filter('my.deleted', '=', '0')										 ->filter('my.customapprovalflowtabid', '=', $tabid)										 ->end(1)										 ->execute();			}			else			{				$approvalflows = XN_Query::create('Content')										 ->tag('approvalflows')										 ->filter('type', 'eic', 'approvalflows')										 ->filter('my.approvalflowsstatus', '=', '1')										 ->filter('my.deleted', '=', '0')										 ->filter('my.tabid', '=', $tabid)										 ->end(1)										 ->execute();			}			$approvalflowdata = array();			if (count($approvalflows) > 0)			{				$approvalflow_info = $approvalflows[0];				$flowdata = $approvalflow_info->my->flowdata;				$amountfieldname = $approvalflow_info->my->fieldname;				$approvalinfo = $approvalflow_info->my->description;				$xml = new DOMDocument();				$xml->loadXML($flowdata);				$routedata = array();				$routes = $xml->getElementsByTagName("Route");				foreach ($routes as $route)				{					$id = $route->getAttribute("ID");					$fromelementid = $route->getAttribute("FromElementID");					$amount = $route->getAttribute("Amount");					$condition = $route->getAttribute("Condition");					$toelementid = $route->getAttribute("ToElementID");					$routedata[] = array($id, $fromelementid, $toelementid, $condition, floatval($amount));				}				$approvalflowdata['route'] = $routedata;				$worknodedata = array();				$decideapprovals = array();				$worknodes = $xml->getElementsByTagName("WorkNode");				foreach ($worknodes as $worknode)				{					$id = $worknode->getAttribute("ID");					$name = $worknode->getAttribute("Name");					$nodetype = $worknode->getAttribute("NodeType");					$decideapproval = $worknode->getAttribute("DecideApproval");					$decideapprovals[$id] = $decideapproval;					$worknodedata[] = array($id, $name, $nodetype);				}				$approvalflowdata['worknode'] = $worknodedata;				$beginnodes = $xml->getElementsByTagName("BeginNode");				foreach ($beginnodes as $beginnode)				{					$id = $beginnode->getAttribute("ID");					$approvalflowdata['beginnode'] = $id;				}			}			if (count($approvalflowdata) > 0)			{				$guid = guid();				$SaveConn = array();				foreach($records as $record)				{					$hasapproval = false;					$loadcontent = XN_Content::load($record, strtolower($formodule));					$amount      = 0;					if ($amountfieldname != "" && $loadcontent->my->$amountfieldname != "")					{						$amount = floatval($loadcontent->my->$amountfieldname);					}					$current_userid = $loadcontent->author;					$report_userid  = getUserProposalByProfileId($current_userid);					$userinfo       = array ('leadership'       => getLeadership($current_userid, $customapprovalflow),											 'mainleadership'   => getMainLeadership($current_userid, $customapprovalflow),											 'author'           => $loadcontent->author,											 'report_userid'    => $report_userid,											 'optionalapproval' => $loadcontent->my->optionalapproval);					$nodes          = getNodes($approvalflowdata, $amount, $record, $guid, $userinfo);					foreach ($nodes as $node => $worknode)					{						if ($worknode == '000000')						{							$approvedata                       = array ();							$approvedata['tabid']              = $tabid;							$approvedata['record']             = $record;							$approvedata['from_userid']        = XN_Profile::$VIEWER;							$approvedata['sourcer']            = $current_userid;							$approvedata['userid']             = $userinfo['report_userid'];							$approvedata['proxyapproval']      = getProxyApproval($report_userid);							$approvedata['flowid']             = $node;							$approvedata['decideapproval']     = $decideapprovals[$node];							$approvedata['nextflowid']         = checknextflowid($approvalflowdata['route'], $node);							$approvedata['finished']           = 'false';							$approvedata['guid']               = $guid;							$approvedata['reply']              = "Approvaling";							$approvedata['amount']             = $amount;							$approvedata['approvalinfo']       = $approvalinfo;							$approvedata['approvalflows']      = $approvalflow_info->id;							$approvedata['customapprovalflow'] = $customapprovalflow;							addapprove($approvedata, 1);							$hasapproval = true;						}						else if ($worknode == '000004')						{							$approvedata                       = array ();							$approvedata['tabid']              = $tabid;							$approvedata['record']             = $record;							$approvedata['from_userid']        = XN_Profile::$VIEWER;							$approvedata['sourcer']            = $current_userid;							$approvedata['userid']             = $current_userid;							$approvedata['proxyapproval']      = getProxyApproval($current_userid);							$approvedata['flowid']             = $node;							$approvedata['decideapproval']     = $decideapprovals[$node];							$approvedata['nextflowid']         = checknextflowid($approvalflowdata['route'], $node);							$approvedata['finished']           = 'false';							$approvedata['guid']               = $guid;							$approvedata['reply']              = "Approvaling";							$approvedata['amount']             = $amount;							$approvedata['approvalinfo']       = $approvalinfo;							$approvedata['approvalflows']      = $approvalflow_info->id;							$approvedata['customapprovalflow'] = $customapprovalflow;							addapprove($approvedata, 1);							$hasapproval = true;						}						else if ($worknode == '000001')						{							$optionalapproval                  = $userinfo['optionalapproval'];							$approvedata                       = array ();							$approvedata['tabid']              = $tabid;							$approvedata['record']             = $record;							$approvedata['from_userid']        = XN_Profile::$VIEWER;							$approvedata['sourcer']            = $current_userid;							$approvedata['userid']             = $optionalapproval;							$approvedata['proxyapproval']      = getProxyApproval($optionalapproval);							$approvedata['flowid']             = $node;							$approvedata['decideapproval']     = $decideapprovals[$node];							$approvedata['nextflowid']         = checknextflowid($approvalflowdata['route'], $node);							$approvedata['finished']           = 'false';							$approvedata['guid']               = $guid;							$approvedata['reply']              = "Approvaling";							$approvedata['amount']             = $amount;							$approvedata['approvalinfo']       = $approvalinfo;							$approvedata['approvalflows']      = $approvalflow_info->id;							$approvedata['customapprovalflow'] = $customapprovalflow;							addapprove($approvedata);							$hasapproval = true;						}						else if ($worknode == '000002')						{							$leadership = $userinfo['leadership'];;							if (is_array($leadership))							{								foreach ($leadership as $leadership_info)								{									$approvedata                       = array ();									$approvedata['tabid']              = $tabid;									$approvedata['record']             = $record;									$approvedata['from_userid']        = XN_Profile::$VIEWER;									$approvedata['sourcer']            = $current_userid;									$approvedata['userid']             = $leadership_info;									$approvedata['proxyapproval']      = getProxyApproval($leadership_info);									$approvedata['flowid']             = $node;									$approvedata['decideapproval']     = $decideapprovals[$node];									$approvedata['nextflowid']         = checknextflowid($approvalflowdata['route'], $node);									$approvedata['finished']           = 'false';									$approvedata['guid']               = $guid;									$approvedata['reply']              = "Approvaling";									$approvedata['amount']             = $amount;									$approvedata['approvalinfo']       = $approvalinfo;									$approvedata['approvalflows']      = $approvalflow_info->id;									$approvedata['customapprovalflow'] = $customapprovalflow;									addapprove($approvedata, 1);								}							}							else							{								$approvedata                       = array ();								$approvedata['tabid']              = $tabid;								$approvedata['record']             = $record;								$approvedata['from_userid']        = XN_Profile::$VIEWER;								$approvedata['sourcer']            = $current_userid;								$approvedata['userid']             = $leadership;								$approvedata['proxyapproval']      = getProxyApproval($leadership);								$approvedata['flowid']             = $node;								$approvedata['decideapproval']     = $decideapprovals[$node];								$approvedata['nextflowid']         = checknextflowid($approvalflowdata['route'], $node);								$approvedata['finished']           = 'false';								$approvedata['guid']               = $guid;								$approvedata['reply']              = "Approvaling";								$approvedata['amount']             = $amount;								$approvedata['approvalinfo']       = $approvalinfo;								$approvedata['approvalflows']      = $approvalflow_info->id;								$approvedata['customapprovalflow'] = $customapprovalflow;								addapprove($approvedata, 1);							}							$hasapproval = true;						}						else if ($worknode == '000003')						{							$mainleadership                    = $userinfo['mainleadership'];							$approvedata                       = array ();							$approvedata['tabid']              = $tabid;							$approvedata['record']             = $record;							$approvedata['from_userid']        = XN_Profile::$VIEWER;							$approvedata['sourcer']            = $current_userid;							$approvedata['userid']             = $mainleadership;							$approvedata['proxyapproval']      = getProxyApproval($mainleadership);							$approvedata['flowid']             = $node;							$approvedata['decideapproval']     = $decideapprovals[$node];							$approvedata['nextflowid']         = checknextflowid($approvalflowdata['route'], $node);							$approvedata['finished']           = 'false';							$approvedata['guid']               = $guid;							$approvedata['reply']              = "Approvaling";							$approvedata['amount']             = $amount;							$approvedata['approvalinfo']       = $approvalinfo;							$approvedata['approvalflows']      = $approvalflow_info->id;							$approvedata['customapprovalflow'] = $customapprovalflow;							addapprove($approvedata, 1);							$hasapproval = true;						}						else if ($worknode == '000000')						{							$approvedata                       = array ();							$approvedata['tabid']              = $tabid;							$approvedata['record']             = $record;							$approvedata['from_userid']        = XN_Profile::$VIEWER;							$approvedata['sourcer']            = $current_userid;							$approvedata['userid']             = $userinfo['report_userid'];							$approvedata['proxyapproval']      = getProxyApproval($report_userid);							$approvedata['flowid']             = $node;							$approvedata['decideapproval']     = $decideapprovals[$node];							$approvedata['nextflowid']         = checknextflowid($approvalflowdata['route'], $node);							$approvedata['finished']           = 'false';							$approvedata['guid']               = $guid;							$approvedata['reply']              = "Approvaling";							$approvedata['amount']             = $amount;							$approvedata['approvalinfo']       = $approvalinfo;							$approvedata['approvalflows']      = $approvalflow_info->id;							$approvedata['customapprovalflow'] = $customapprovalflow;							addapprove($approvedata, 1);							$hasapproval = true;						}						else						{							$approvedata                = array ();							$approvedata['tabid']       = $tabid;							$approvedata['record']      = $record;							$approvedata['from_userid'] = $current_userid;							$approvedata['sourcer']     = $current_userid;							$approvedata['userid']      = $worknode;							$approvedata['proxyapproval'] = getProxyApproval($worknode);							$approvedata['flowid']         = $node;							$approvedata['decideapproval'] = $decideapprovals[$node];							$approvedata['nextflowid']     = checknextflowid($approvalflowdata['route'], $node);							$approvedata['finished']           = 'false';							$approvedata['guid']               = $guid;							$approvedata['reply']              = "Approvaling";							$approvedata['amount']             = $amount;							$approvedata['approvalinfo']       = $approvalinfo;							$approvedata['approvalflows']      = $approvalflow_info->id;							$approvedata['customapprovalflow'] = $customapprovalflow;							addapprove($approvedata, 1);							$hasapproval = true;						}					}					if ($hasapproval)					{						$loadcontent->my->approvalstatus = 1;						$status                          = strtolower($formodule).'status';						$loadcontent->my->$status        = 'Approvaling';						$loadcontent->my->submitapprovaldatetime = date("Y-m-d H:i");						$SaveConn[] = $loadcontent;					}				}				if(count($SaveConn) > 0){					foreach (array_chunk($SaveConn,50) as $chunk){						XN_Content::batchsave($chunk,strtolower($formodule));					}				}			}		}	}function savemainrecord($contentid, $module,$customapprovalflow){	if ($customapprovalflow == "approvalflows")	{	    $load_approvals_content = XN_Content::load($contentid);	    $load_approvals_content->my->approvalstatus = '2';	    $status = strtolower($module) . 'status';	    $load_approvals_content->my->$status = 'Agree';	    $load_approvals_content->my->finishapprover = XN_Profile::$VIEWER;	    $load_approvals_content->my->submitapprovalreplydatetime = date("Y-m-d H:i");	    $load_approvals_content->save(getmoduletag($module, $load_approvals_content));	    approval_event($module, $contentid, 'Agree');	}	else	{		global $global_session; 		$tabdata  = $global_session['tabdata']; 	    $approvaltabs = $tabdata['approvaltabs'];	     	    $tabid = getTabid($module);	    if (in_array($tabid, $approvaltabs))	    {			sendapproval($contentid,$module,"");		}		else		{		    $load_approvals_content = XN_Content::load($contentid);		    $load_approvals_content->my->approvalstatus = '2';		    $status = strtolower($module) . 'status';		    $load_approvals_content->my->$status = 'Agree';		    $load_approvals_content->my->finishapprover = XN_Profile::$VIEWER;		    $load_approvals_content->my->submitapprovalreplydatetime = date("Y-m-d H:i");		    $load_approvals_content->save(getmoduletag($module, $load_approvals_content));		    approval_event($module, $contentid, 'Agree');		}	} }function saveapproval($recordId, $formodule, $reply, $reply_text){    try    {        $focus = XN_Content::load($recordId, 'approvals');        $approvals_id = $focus->my->record;        $customapprovalflow = $focus->my->customapprovalflow;        $tabid = $focus->my->tabid;        $flowid = $focus->my->flowid;        $guid = $focus->my->guid;        $decideapproval = $focus->my->decideapproval;        $approvals_module = getModule($tabid);        $nextflowid = $focus->my->nextflowid;        approval_check($approvals_module,$approvals_id);        //finished='false':待审批记录        if ($focus->my->finished == 'false')        {                        //Agree:审批通过,Disagree:不通过;Approvaling:待审批；Saved:待提交；            if ($reply == 'Agree')            {                if ($nextflowid == '-1')                {                    //由record获得审批记录并修改finished='true'，即为：审批通过。                    $type = "Self";                    if ($focus->my->userid != XN_Profile::$VIEWER) $type = "Proxy";                    $data = array('finished'                    => 'true',                                  'reply_text'                  => $reply_text,                                  'reply'                       => $reply,                                  'approvaltype'                => $type,                                  'approver'                    => XN_Profile::$VIEWER,                                  'finishedapprover'            => 'true',                                  'submitapprovalreplydatetime' => date("Y-m-d H:i"));                    update($focus, 'Approvals', $data);                    if ($decideapproval == "true")                    {                        $approvals = XN_Query::create('Content')                            ->filter('type', 'eic', 'approvals')                            ->filter('my.deleted', '=', '0')                            ->filter('my.tabid', '=', $tabid)                            ->filter('my.record', '=', $approvals_id)                            ->filter('my.finished', '=', 'false')                            ->order('published', XN_Order::DESC)                            ->execute();                        if (count($approvals) > 0)                        {                            foreach ($approvals as $approval_info)                            {                                $approval_info->my->finished = 'true';                                $approval_info->my->reply_text = getTranslatedFormatString('LBL_DECIDEAPPROVAL_MSG');                                $approval_info->my->reply = 'Agree';                                $approval_info->my->deleted = '2';                                $approval_info->my->approver = XN_Profile::$VIEWER;                                $approval_info->my->submitapprovalreplydatetime = date("Y-m-d H:i:s");                                $approval_info->save('approvals');                            }                        }                        /*$load_approvals_content = XN_Content::load($approvals_id);                        $load_approvals_content->my->approvalstatus = '2';                        $status = strtolower($approvals_module) . 'status';                        $load_approvals_content->my->$status = 'Agree';                        $load_approvals_content->my->finishapprover = XN_Profile::$VIEWER;                        $load_approvals_content->my->submitapprovalreplydatetime = date("Y-m-d H:i");                        $load_approvals_content->save(getmoduletag($approvals_module, $load_approvals_content));                        approval_event($approvals_module, $approvals_id, 'Agree');						*/						savemainrecord($approvals_id, $approvals_module,$customapprovalflow);                        detailapproval($tabid, $approvals_id);                    }                    else                    {                        $approvals = XN_Query::create('Content')                            ->filter('type', 'eic', 'approvals')                            ->filter('my.deleted', '=', '0')                            ->filter('my.tabid', '=', $tabid)                            ->filter('my.record', '=', $approvals_id)                            ->filter('my.decideapproval', '=', 'true')                            ->filter('my.finished', '=', 'false')                            ->order('published', XN_Order::DESC)                            ->execute();                        if (count($approvals) > 0)                        {                            foreach ($approvals as $approval_info)                            {                                $approval_info->my->finished = 'true';                                $approval_info->my->reply_text = getTranslatedFormatString('LBL_DECIDEAPPROVAL_MSG');                                $approval_info->my->reply = 'Agree';                                $approval_info->my->deleted = '2';                                $approval_info->my->approver = XN_Profile::$VIEWER;                                $approval_info->my->submitapprovalreplydatetime = date("Y-m-d H:i:s");                                $approval_info->save('approvals');                            }                        }                        $approvals = XN_Query::create('Content')                            ->filter('type', 'eic', 'approvals')                            ->filter('my.deleted', '=', '0')                            ->filter('my.tabid', '=', $tabid)                            ->filter('my.record', '=', $approvals_id)                            ->filter('my.finished', '=', 'false')                            ->order('published', XN_Order::DESC)                            ->execute();                        if (count($approvals) == 0)                        {                            /*$load_approvals_content = XN_Content::load($approvals_id);                            $load_approvals_content->my->approvalstatus = '2';                            $status = strtolower($approvals_module) . 'status';                            $load_approvals_content->my->$status = 'Agree';                            $load_approvals_content->my->finishapprover = XN_Profile::$VIEWER;                            $load_approvals_content->my->submitapprovalreplydatetime = date("Y-m-d H:i");                            $load_approvals_content->save(getmoduletag($approvals_module, $load_approvals_content));                            approval_event($approvals_module, $approvals_id, 'Agree');*/							savemainrecord($approvals_id, $approvals_module,$customapprovalflow);                        }                        detailapproval($tabid, $approvals_id);                    }                }                else                {					if ($customapprovalflow != "approvalflows")					{						global $supplierid; 				        $approvalflows = XN_Query::create('Content')				            ->tag($customapprovalflow)				            ->filter('type', 'eic', $customapprovalflow)							->filter('my.supplierid', '=', $supplierid)				            ->filter('my.approvalflowsstatus', '=', '1')				            ->filter('my.deleted', '=', '0')				            ->filter('my.customapprovalflowtabid', '=', $tabid)							->end(1)				            ->execute();					}					else					{				        $approvalflows = XN_Query::create('Content')				            ->tag('approvalflows')				            ->filter('type', 'eic', 'approvalflows')				            ->filter('my.approvalflowsstatus', '=', '1')				            ->filter('my.deleted', '=', '0')				            ->filter('my.tabid', '=', $tabid)							->end(1)				            ->execute();					}                     $approvalflowdata = array();                    if (count($approvalflows) > 0)                    {                        $approvalflow_info = $approvalflows[0];                        $flowdata = $approvalflow_info->my->flowdata;                        $amountfieldname = $approvalflow_info->my->fieldname;                        $approvalinfo = $approvalflow_info->my->description;                        $xml = new DOMDocument();                        $xml->loadXML($flowdata);                        $routedata = array();                        $routes = $xml->getElementsByTagName("Route");                        foreach ($routes as $route)                        {                            $id = $route->getAttribute("ID");                            $fromelementid = $route->getAttribute("FromElementID");                            $amount = $route->getAttribute("Amount");                            $condition = $route->getAttribute("Condition");                            $toelementid = $route->getAttribute("ToElementID");                            $routedata[] = array($id, $fromelementid, $toelementid, $condition, floatval($amount));                        }                        $approvalflowdata['route'] = $routedata;                        $worknodedata = array();                        $decideapprovals = array();                        $worknodes = $xml->getElementsByTagName("WorkNode");                        foreach ($worknodes as $worknode)                        {                            $id = $worknode->getAttribute("ID");                            $name = $worknode->getAttribute("Name");                            $nodetype = $worknode->getAttribute("NodeType");                            $decideapproval = $worknode->getAttribute("DecideApproval");                            $decideapprovals[$id] = $decideapproval;                            $worknodedata[] = array($id, $name, $nodetype);                        }                        $approvalflowdata['worknode'] = $worknodedata;                        $beginnodes = $xml->getElementsByTagName("BeginNode");                        foreach ($beginnodes as $beginnode)                        {                            $id = $beginnode->getAttribute("ID");                            $approvalflowdata['beginnode'] = $id;                        }                    }                    if (count($approvalflowdata) > 0)                    {                        $hasapproval = false;                        $loadmodulecontent = XN_Content::load($approvals_id, strtolower($approvals_module));                        $amount = 0;                        if ($amountfieldname != "" && $loadmodulecontent->my->$amountfieldname != "")                        {                            $amount = floatval($loadmodulecontent->my->$amountfieldname);                        }                        //$current_userid = XN_Profile::$VIEWER;                        $current_userid = $loadmodulecontent->author;                        $report_userid = getUserProposalByProfileId($current_userid);                        $userinfo = array('leadership'       => getLeadership($current_userid,$customapprovalflow),                                          'mainleadership'   => getMainLeadership($current_userid,$customapprovalflow),                                          'author'           => $loadmodulecontent->author,                                          'report_userid'    => $report_userid,                                          'optionalapproval' => $loadmodulecontent->my->optionalapproval);                        $nodes = getNodes($approvalflowdata, $amount, $approvals_id, $guid, $userinfo, $flowid);                        if (count($nodes) > 0)                        {                            foreach ($nodes as $node => $worknode)                            {                                if ($worknode == '000000')                                {                                    $approvedata = array();                                    $approvedata['tabid'] = $tabid;                                    $approvedata['record'] = $approvals_id;                                    $approvedata['from_userid'] = XN_Profile::$VIEWER;                                    $approvedata['sourcer'] = $current_userid;                                    $approvedata['userid'] = $report_userid;                                    $approvedata['proxyapproval'] = getProxyApproval($report_userid);                                    $approvedata['flowid'] = $node;                                    $approvedata['decideapproval'] = $decideapprovals[$node];                                    $approvedata['nextflowid'] = checknextflowid($approvalflowdata['route'], $node);                                    $approvedata['finished'] = 'false';                                    $approvedata['guid'] = $guid;                                    $approvedata['reply'] = "Approvaling";                                    $approvedata['amount'] = $amount;                                    $approvedata['approvalinfo'] = $approvalinfo;                                    $approvedata['approvalflows'] = $approvalflow_info->id;                                    $approvedata['customapprovalflow'] = $customapprovalflow;                                    addapprove($approvedata);                                    $hasapproval = true;                                }                                else if ($worknode == '000004')                                {                                    $approvedata = array();                                    $approvedata['tabid'] = $tabid;                                    $approvedata['record'] = $approvals_id;                                    $approvedata['from_userid'] = XN_Profile::$VIEWER;                                    $approvedata['sourcer'] = $current_userid;                                    $approvedata['userid'] = $current_userid;                                    $approvedata['proxyapproval'] = getProxyApproval($current_userid);                                    $approvedata['flowid'] = $node;                                    $approvedata['decideapproval'] = $decideapprovals[$node];                                    $approvedata['nextflowid'] = checknextflowid($approvalflowdata['route'], $node);                                    $approvedata['finished'] = 'false';                                    $approvedata['guid'] = $guid;                                    $approvedata['reply'] = "Approvaling";                                    $approvedata['amount'] = $amount;                                    $approvedata['approvalinfo'] = $approvalinfo;                                    $approvedata['approvalflows'] = $approvalflow_info->id;                                    $approvedata['customapprovalflow'] = $customapprovalflow;                                    addapprove($approvedata);                                    $hasapproval = true;                                }                                else if ($worknode == '000001')                                {                                    $optionalapproval = $userinfo['optionalapproval'];                                    if ($optionalapproval != "")                                    {                                        $approvedata = array();                                        $approvedata['tabid'] = $tabid;                                        $approvedata['record'] = $approvals_id;                                        $approvedata['from_userid'] = XN_Profile::$VIEWER;                                        $approvedata['sourcer'] = $current_userid;                                        $approvedata['userid'] = $optionalapproval;                                        $approvedata['proxyapproval'] = getProxyApproval($optionalapproval);                                        $approvedata['flowid'] = $node;                                        $approvedata['decideapproval'] = $decideapprovals[$node];                                        $approvedata['nextflowid'] = checknextflowid($approvalflowdata['route'], $node);                                        $approvedata['finished'] = 'false';                                        $approvedata['guid'] = $guid;                                        $approvedata['reply'] = "Approvaling";                                        $approvedata['amount'] = $amount;                                        $approvedata['approvalinfo'] = $approvalinfo;                                        $approvedata['approvalflows'] = $approvalflow_info->id;                                        $approvedata['customapprovalflow'] = $customapprovalflow;                                        addapprove($approvedata);                                        $hasapproval = true;                                    }                                }                                else if ($worknode == '000002')                                {                                    $leadership = $userinfo['leadership'];                                    if (is_array($leadership))                                    {                                        foreach ($leadership as $leadership_info)                                        {                                            $approvedata = array();                                            $approvedata['tabid'] = $tabid;                                            $approvedata['record'] = $approvals_id;                                            $approvedata['from_userid'] = XN_Profile::$VIEWER;                                            $approvedata['sourcer'] = $current_userid;                                            $approvedata['userid'] = $leadership_info;                                            $approvedata['proxyapproval'] = getProxyApproval($leadership_info);                                            $approvedata['flowid'] = $node;                                            $approvedata['decideapproval'] = $decideapprovals[$node];                                            $approvedata['nextflowid'] = checknextflowid($approvalflowdata['route'], $node);                                            $approvedata['finished'] = 'false';                                            $approvedata['guid'] = $guid;                                            $approvedata['reply'] = "Approvaling";                                            $approvedata['amount'] = $amount;                                            $approvedata['approvalinfo'] = $approvalinfo;                                            $approvedata['approvalflows'] = $approvalflow_info->id;                                            $approvedata['customapprovalflow'] = $customapprovalflow;                                            addapprove($approvedata);                                        }                                    }                                    else                                    {                                        $approvedata = array();                                        $approvedata['tabid'] = $tabid;                                        $approvedata['record'] = $approvals_id;                                        $approvedata['from_userid'] = XN_Profile::$VIEWER;                                        $approvedata['sourcer'] = $current_userid;                                        $approvedata['userid'] = $leadership;                                        $approvedata['proxyapproval'] = getProxyApproval($leadership);                                        $approvedata['flowid'] = $node;                                        $approvedata['decideapproval'] = $decideapprovals[$node];                                        $approvedata['nextflowid'] = checknextflowid($approvalflowdata['route'], $node);                                        $approvedata['finished'] = 'false';                                        $approvedata['guid'] = $guid;                                        $approvedata['reply'] = "Approvaling";                                        $approvedata['amount'] = $amount;                                        $approvedata['approvalinfo'] = $approvalinfo;                                        $approvedata['approvalflows'] = $approvalflow_info->id;                                        $approvedata['customapprovalflow'] = $customapprovalflow;                                        addapprove($approvedata);                                    }                                    $hasapproval = true;                                }                                else if ($worknode == '000003')                                {                                    $mainleadership = $userinfo['mainleadership'];                                    $approvedata = array();                                    $approvedata['tabid'] = $tabid;                                    $approvedata['record'] = $approvals_id;                                    $approvedata['from_userid'] = XN_Profile::$VIEWER;                                    $approvedata['sourcer'] = $current_userid;                                    $approvedata['userid'] = $mainleadership;                                    $approvedata['proxyapproval'] = getProxyApproval($mainleadership);                                    $approvedata['flowid'] = $node;                                    $approvedata['decideapproval'] = $decideapprovals[$node];                                    $approvedata['nextflowid'] = checknextflowid($approvalflowdata['route'], $node);                                    $approvedata['finished'] = 'false';                                    $approvedata['guid'] = $guid;                                    $approvedata['reply'] = "Approvaling";                                    $approvedata['amount'] = $amount;                                    $approvedata['approvalinfo'] = $approvalinfo;                                    $approvedata['approvalflows'] = $approvalflow_info->id;                                    $approvedata['customapprovalflow'] = $customapprovalflow;                                    addapprove($approvedata);                                    $hasapproval = true;                                }                                else                                {                                    $approvedata = array();                                    $approvedata['tabid'] = $tabid;                                    $approvedata['record'] = $approvals_id;                                    $approvedata['from_userid'] = XN_Profile::$VIEWER;                                    $approvedata['sourcer'] = $current_userid;                                    $approvedata['userid'] = $worknode;                                    $approvedata['proxyapproval'] = getProxyApproval($worknode);                                    $approvedata['flowid'] = $node;                                    $approvedata['decideapproval'] = $decideapprovals[$node];                                    $approvedata['nextflowid'] = checknextflowid($approvalflowdata['route'], $node);                                    $approvedata['finished'] = 'false';                                    $approvedata['guid'] = $guid;                                    $approvedata['reply'] = "Approvaling";                                    $approvedata['amount'] = $amount;                                    $approvedata['approvalinfo'] = $approvalinfo;                                    $approvedata['approvalflows'] = $approvalflow_info->id;                                    $approvedata['customapprovalflow'] = $customapprovalflow;                                    addapprove($approvedata);                                    $hasapproval = true;                                }                            }                        }                        else                        {                            $type = "Self";                            if ($focus->my->userid != XN_Profile::$VIEWER) $type = "Proxy";                            $data = array('finished'                    => 'true',                                          'reply_text'                  => $reply_text,                                          'reply'                       => $reply,                                          'approvaltype'                => $type,                                          'approver'                    => XN_Profile::$VIEWER,                                          'submitapprovalreplydatetime' => date("Y-m-d H:i"));                            update($focus, 'Approvals', $data);                            $approvals = XN_Query::create('Content')                                ->tag('approvals')                                ->filter('type', 'eic', 'approvals')                                ->filter('my.deleted', '=', '0')                                ->filter('my.tabid', '=', $tabid)                                ->filter('my.record', '=', $approvals_id)                                ->filter('my.decideapproval', '=', 'true')                                ->filter('my.finished', '=', 'false')                                ->order('published', XN_Order::DESC)                                ->execute();                            if (count($approvals) > 0)                            {                                foreach ($approvals as $approval_info)                                {                                    $approval_info->my->finished = 'true';                                    $approval_info->my->reply_text = getTranslatedFormatString('LBL_DECIDEAPPROVAL_MSG');                                    $approval_info->my->reply = 'Agree';                                    $approval_info->my->deleted = '2';                                    $approval_info->my->approver = XN_Profile::$VIEWER;                                    $approval_info->my->submitapprovalreplydatetime = date("Y-m-d H:i:s");                                    $approval_info->save('approvals');                                }                            }                            $approvals = XN_Query::create('Content')                                ->tag('approvals')                                ->filter('type', 'eic', 'approvals')                                ->filter('my.tabid', '=', $tabid)                                ->filter('my.record', '=', $approvals_id)                                ->filter('my.finished', '=', 'false')                                ->order('published', XN_Order::DESC)                                ->execute();                            if (count($approvals) == 0)                            {                                /*$load_approvals_content = XN_Content::load($approvals_id);                                $load_approvals_content->my->approvalstatus = '2';                                $status = strtolower($approvals_module) . 'status';                                $load_approvals_content->my->$status = 'Agree';                                $load_approvals_content->my->finishapprover = XN_Profile::$VIEWER;                                $load_approvals_content->my->submitapprovalreplydatetime = date("Y-m-d H:i");                                $load_approvals_content->save(getmoduletag($approvals_module, $load_approvals_content));                                approval_event($approvals_module, $approvals_id, 'Agree');*/								savemainrecord($approvals_id, $approvals_module,$customapprovalflow);                             }                            detailapproval($tabid, $approvals_id);                        }                        if ($hasapproval)                        {                            $type = "Self";                            if ($focus->my->userid != XN_Profile::$VIEWER) $type = "Proxy";                            $data = array('finished'                    => 'true',                                          'reply_text'                  => $reply_text,                                          'reply'                       => $reply,                                          'approvaltype'                => $type,                                          'approver'                    => XN_Profile::$VIEWER,                                          'submitapprovalreplydatetime' => date("Y-m-d H:i"));                            update($focus, 'Approvals', $data);                        }                    }                }				if ($formodule != "ApprovalCenters")				{	                statuscode($formodule);	                die();				}            }            else if ($reply == 'Disagree')            {                $load_approvals_content = XN_Content::load($approvals_id);                $load_approvals_content->my->approvalstatus = '3';                $status = strtolower($approvals_module) . 'status';                $load_approvals_content->my->$status = 'Disagree';                $load_approvals_content->my->finishapprover = XN_Profile::$VIEWER;                $load_approvals_content->my->submitapprovalreplydatetime = date("Y-m-d H:i");                $load_approvals_content->save(getmoduletag($approvals_module, $load_approvals_content));                $approvals = XN_Query::create('Content')                    ->tag('approvals')                    ->filter('type', 'eic', 'approvals')                    ->filter('my.tabid', '=', $tabid)                    ->filter('my.record', '=', $approvals_id)                    ->filter('my.finished', '=', 'false')                    ->order('published', XN_Order::DESC)                    ->execute();                if (count($approvals) > 0)                {                    foreach ($approvals as $approval_info)                    {                        $type = "Self";                        if ($focus->my->userid != XN_Profile::$VIEWER) $type = "Proxy";                        $data = array('finished'                    => 'true',                                      'reply_text'                  => $reply_text,                                      'reply'                       => $reply,                                      'approvaltype'                => $type,                                      'approver'                    => XN_Profile::$VIEWER,                                      'finishedapprover'            => 'true',                                      'submitapprovalreplydatetime' => date("Y-m-d H:i"));                        update($approval_info, 'Approvals', $data);                    }                }                approval_event($approvals_module, $approvals_id, 'Disagree');                detailapproval($tabid, $approvals_id, 'Disagree');            }			if ($formodule != "ApprovalCenters")			{	            statuscode($formodule);	            die();			}        }        else        {            echo '{"statusCode":300,"message":"记录ID错误!"}';            die();        }    }    catch (XN_Exception $e)    {        echo '{"statusCode":300,"message":"' . $e->getMessage() . '"}';        die();    }}function statuscode($formodule){ 	if ($formodule != "APP")	{	    if (isset($_REQUEST['pos']) && $_REQUEST['pos'] != '' && isset($_REQUEST['count']) && $_REQUEST['count'] != '')	    {	        if (intval($_REQUEST['pos']) < intval($_REQUEST['count']))	        {	            echo '{"statusCode":200,"message":null}';	        }	        else	        {	            echo '{"statusCode":200,"message":null,"closeCurrent":"true"}';	        }	    }	    else	    {	        echo '{"statusCode":200,"tabid":"'.$formodule.'","closeCurrent":"true"}';	    }	    die();	} 	else	{		 echo 'ok';		 die();	} }function redirect($approvals_module){    if (isset($_REQUEST['module']) && $_REQUEST['from'] == 'listview')    {        echo '{"statusCode":200,"message":null,"tabid":"' . $approvals_module . '","closeCurrent":"true","forward":null}';    }    else    {		if(isset($_REQUEST['record']) && $_REQUEST['record'] !='')		{ 			$record = $_REQUEST['record'];			echo '{"statusCode":200,"message":null,"tabid":null,"closeCurrent":"true","reload":"/index.php?module='.$approvals_module.'&action=EditView&record='.$record.'"}';		}		else		{ 	        echo '{"statusCode":200,"message":null,"tabid":"edit","closeCurrent":"true","forward":null}';		}    }    die();}function detailapproval($tabid, $record, $reply = "Agree"){    $detailapprovals = array();    $tabdata_file = 'cache/' . XN_Application::$CURRENT_URL . '/tabdata.php';    include($tabdata_file);    if (in_array($tabid, $detailapprovals))    {        if (isset($_REQUEST['details']))        {            try            {                $details = explode(",", $_REQUEST['details']);                $approvals_module = getModule($tabid);                $approvals = XN_Query::create('Content')->tag(strtolower($approvals_module) . '_details')                    ->filter('type', 'eic', strtolower($approvals_module) . '_details')                    ->filter('my.record', '=', $record)                    ->filter('my.deleted', '=', '0')                    ->order("published", XN_Order::DESC)                    ->execute();                foreach ($approvals as $approval_info)                {                    if (!in_array($approval_info->id, $details))                    {                        $approval_info->my->deleted = "2";                        $approval_info->my->approvalapprover = XN_Profile::$VIEWER;                        $approval_info->my->approvaldatetime = date("Y-m-d H:i");                        $approval_info->save(strtolower($approvals_module) . '_details');                    }                }            }            catch (XN_Exception $e)            {            }        }    }}function update($focus, $module, $data){    if (isset($data) && is_array($data))    {        foreach ($data as $key => $column_field)        {            $focus->my->$key = $column_field;        }        $focus->save(strtolower($module));        $recordid = $focus->my->record;        $reply = $data['reply'];        $approver = $data['approver'];        $finished = $data['finished'];        $approvalcenters = XN_Query::create('Content')            ->tag('approvalcenters')            ->filter('type', 'eic', 'approvalcenters')            ->filter('my.record', '=', $recordid)            ->execute();        if (count($approvalcenters) > 0)        {            $approvalcenter_info = $approvalcenters[0];            if ($data['finishedapprover'] == 'true')            {                if ($reply == "Agree")                {                    $approvalcenter_info->my->pendingapprover = '';                    $approvalcenter_info->my->finished = $finished;                    $approvalcenter_info->my->finishapprover = $approver;                    $approvalcenter_info->my->finishapprovaldatetime = date("Y-m-d H:i");                    $approvalcenter_info->my->lastapprovaldatetime = date("Y-m-d H:i");                    $approvalcenter_info->my->approvalstatus = '2';                    $approvalcenter_info->my->approvalcentersstatus = 'Agree';                }                else if ($reply == "Disagree")                {                    $approvalcenter_info->my->pendingapprover = '';                    $approvalcenter_info->my->finished = $finished;                    $approvalcenter_info->my->finishapprover = $approver;                    $approvalcenter_info->my->finishapprovaldatetime = date("Y-m-d H:i");                    $approvalcenter_info->my->lastapprovaldatetime = date("Y-m-d H:i");                    $approvalcenter_info->my->approvalstatus = '3';                    $approvalcenter_info->my->approvalcentersstatus = 'Disagree';                }            }            else            {                $pendingapprover = $approvalcenter_info->my->pendingapprover;                if (is_array($pendingapprover))                {                    if (in_array($approver, $pendingapprover))                    {                        $newpendingapprover = array();                        foreach($pendingapprover as $pendingapprover_info)                        {                            if ($pendingapprover_info != $approver)                            {                                $newpendingapprover[] = $pendingapprover_info;                            }                        }                        $approvalcenter_info->my->pendingapprover = $newpendingapprover;                    }                }                else                {                    if ($approver == $pendingapprover)                    {                        $approvalcenter_info->my->pendingapprover = '';                    }                }                $approvalcenter_info->my->lastapprovaldatetime = date("Y-m-d H:i");            }            $oldapprover = $approvalcenter_info->my->approver;            if (isset($oldapprover) && $oldapprover != "")            {                $oldapprover = (array)$oldapprover;                if (!in_array($approver, $oldapprover))                {                    $oldapprover[] = $approver;                    $approvalcenter_info->my->approver = $oldapprover;                }            }            else            {                 $approvalcenter_info->my->approver = $approver;            }            $approvalcenter_info->save('approvalcenters');						refresh_approval($approver);        }    }}function approval_check($module, $id, $event){    require_once('modules/' . $module . '/' . $module . '.php');    $focus = CRMEntity::getInstance($module);    if (method_exists($focus, 'approval_check'))    {        try        {            $focus->approval_check($id, $event);        }        catch (XN_Exception $e)        {            echo '{"statusCode":300,"message":"'.$e->getMessage().'!"}';            die();        }    }}function approval_event($approval_module, $approvals_id, $event){    require_once('modules/' . $approval_module . '/' . $approval_module . '.php');    $focus = CRMEntity::getInstance($approval_module);    if (method_exists($focus, 'approval_event'))    {        try        {            $focus->approval_event($approvals_id, $event);        }        catch (XN_Exception $e)        {        }    }}function addapprove($data,$new=0){    $tabid = $data['tabid'];    $userid = $data['userid'];    $record = $data['record'];    $reply = $data['reply'];    detailapproval($tabid, $record);    $approvals = XN_Query::create('Content')        ->tag('approvals')        ->filter('type', 'eic', 'approvals')        ->filter('my.userid', '=', $userid)        ->filter('my.record', '=', $record)        ->filter('my.finished', '=', 'false')        ->execute();    if (count($approvals) == 0)    {        $newcontent = XN_Content::create('approvals', '', false);        $newcontent->my->deleted = '0';        foreach ($data as $fieldname => $value)        {            $newcontent->my->$fieldname = $value;        }        $newcontent->my->sequence = strtotime("now");        $newcontent->save('approvals');    }    $approvalcenters = XN_Query::create('Content')        ->tag('approvalcenters')        ->filter('type', 'eic', 'approvalcenters')        ->filter('my.record', '=', $record)        ->execute();    if (count($approvalcenters) == 0)    {        $newcontent = XN_Content::create('approvalcenters', '', false);        $newcontent->my->deleted = '0';        $newcontent->my->record = $data['record'];        $newcontent->my->tabid = $data['tabid'];        $newcontent->my->sourcer = XN_Profile::$VIEWER;        $newcontent->my->finished = $data['finished'];        $newcontent->my->finishapprover = '';        $newcontent->my->finishapprovaldatetime = '';        $newcontent->my->guid = $data['guid'];        $newcontent->my->amount = $data['amount'];        $newcontent->my->approver = '';        $newcontent->my->pendingapprover = $data['userid'];        $newcontent->my->flowid = $data['approvalflows'];        $newcontent->my->lastapprovaldatetime = '';        $newcontent->my->approvalstatus = '1';        $newcontent->my->approvalcentersstatus = 'Approvaling';		$newcontent->my->customapprovalflow = $data['customapprovalflow'];        $newcontent->save('approvalcenters');      }    else    {        $approvalcenter_info = $approvalcenters[0];        $userid = $data['userid'];        $pendingapprover = (array)($approvalcenter_info->my->pendingapprover);        if (!in_array($userid, $pendingapprover))        {            $pendingapprover[] = $userid;            $approvalcenter_info->my->pendingapprover = $pendingapprover;        }        $approvalcenter_info->my->finished = $data['finished'];        $approvalcenter_info->my->finishapprover = '';        $approvalcenter_info->my->finishapprovaldatetime = '';        $approvalcenter_info->my->approvalstatus = '1';        $approvalcenter_info->my->approvalcentersstatus = $reply;        if ($new == 1)        {            $approvalcenter_info->my->approver = '';            $approvalcenter_info->my->lastapprovaldatetime = '';        }        $approvalcenter_info->save('approvalcenters');     }       $tabid = $data['tabid'];    $approvals_module = getModule($tabid);    $lowermodule = strtolower($approvals_module);    $userid = $data['userid'];	 	refresh_approval($userid);      $load_content = XN_Content::load($record, $lowermodule);    $approver = (array)($load_content->my->approver);    if (!in_array($userid, $approver))    {        $approver[] = $userid;        $load_content->my->approver = $approver;    }    $load_content->save(getmoduletag($approvals_module, $load_content));} function masssendapproval($records,$formodule){    $approvals = XN_Query::create ( 'Content_Count' )        ->tag ( 'approvals' )        ->filter ( 'type', 'eic', 'approvals' )        ->filter ( 'my.finished', '=', 'false' )        ->filter ( 'my.deleted', '=', '0' )        ->filter ( 'my.record', 'in', $records )        ->group("my.record")        ->rollup();    $approvals->execute();    $count=$approvals->getTotalCount();    if($count==count($records) )    {        return true;    }else{        $hasapproval_ids=array();        foreach($approvals as $approval_info){            $hasapproval_ids[]=$approval_info->my->record;        }        $approval_ids=array_diff($records,$hasapproval_ids);    }    try{        global $global_session; $tabdata  = $global_session['tabdata'];         $approvaltabs=$tabdata['approvaltabs'];    }    catch(XN_Exception $e){        create_tab_data_file();        global $global_session; $tabdata  = $global_session['tabdata'];         $approvaltabs=$tabdata['approvaltabs'];    }    $tabid = getTabid($formodule);    if (in_array($tabid, $approvaltabs))    {        $approvalflows = XN_Query::create ( 'Content' )            ->tag ( 'approvalflows' )            ->filter ( 'type', 'eic', 'approvalflows' )            ->filter ( 'my.approvalflowsstatus', '=', '1' )            ->filter ( 'my.deleted', '=', '0' )            ->filter ( 'my.tabid', '=', $tabid )            ->execute();        $approvalflowdata = array();        if (count($approvalflows) > 0)        {            $approvalflow_info = $approvalflows[0];            $flowdata = $approvalflow_info->my->flowdata;            $amountfieldname  = $approvalflow_info->my->fieldname;            $approvalinfo  = $approvalflow_info->my->description;            $xml = new DOMDocument();            $xml->loadXML($flowdata);            $routedata = array();            $routes  = $xml->getElementsByTagName("Route");            foreach ($routes as $route)            {                $id = $route->getAttribute("ID");                $fromelementid = $route->getAttribute("FromElementID");                $amount = $route->getAttribute("Amount");                $condition = $route->getAttribute("Condition");                $toelementid = $route->getAttribute("ToElementID");                $routedata[] = array($id,$fromelementid,$toelementid,$condition,floatval($amount));            }            $approvalflowdata['route'] = $routedata;            $worknodedata = array();            $decideapprovals = array();            $worknodes  = $xml->getElementsByTagName("WorkNode");            foreach ($worknodes as $worknode)            {                $id = $worknode->getAttribute("ID");                $name = $worknode->getAttribute("Name");                $nodetype = $worknode->getAttribute("NodeType");                $decideapproval = $worknode->getAttribute("DecideApproval");                $decideapprovals[$id] = $decideapproval;                $worknodedata[] = array($id,$name,$nodetype);            }            $approvalflowdata['worknode'] = $worknodedata;            $beginnodes  = $xml->getElementsByTagName("BeginNode");            foreach ($beginnodes as $beginnode)            {                $id = $beginnode->getAttribute("ID");                $approvalflowdata['beginnode'] = $id;            }        }        $loadcontents = XN_Content::loadMany( $records, strtolower($formodule));        if (count($approvalflowdata) > 0)        {            $guid = guid();            $amounts = array();            $current_userids=array();            foreach($loadcontents as $loadcontent){                $current_userids[]=$loadcontent->author;            }            $report_userids=getUserProposalByProfileIds($current_userids);            $leaderships=getLeaderships($current_userids);            $mainLeadership=getMainLeaderships($current_userids);            foreach($loadcontents as $loadcontent){                if ($amountfieldname != "" && $loadcontent->my->$amountfieldname != "")                {                    $amounts[$loadcontent->id]=floatval($loadcontent->my->$amountfieldname);                }                $current_userid = $loadcontent->author;                $report_userid = $report_userids[$current_userid];                $userinfos[$loadcontent->id]=array('leadership' => $leaderships[$current_userid],                    'mainleadership' => $mainLeadership[$current_userid],                    'author' => $loadcontent->author,                    'report_userid' => $report_userid,                    'optionalapproval' =>  $loadcontent->my->optionalapproval);            }            $nodes = getmassNodes($approvalflowdata,$amounts,$approval_ids,$guid,$userinfos);            //echo "---";print_r($nodes);echo "---";exit();            $approvedata = array();            $approvalcenterdata=array();            foreach($loadcontents as $loadcontent){                $record=$loadcontent->id;                $userinfo=$userinfos[$record];                $amount=$amounts[$record];                $current_userid=$loadcontent->author;                $report_userid=$report_userids[$record];                $key=1;                foreach ($nodes  as $node => $worknode)                {                    if ($worknode == '000000' )                    {                        $approvedata[$record][$key]['tabid'] = $tabid;                        $approvedata[$record][$key]['record'] = $record;                        $approvedata[$record][$key]['from_userid'] = XN_Profile::$VIEWER;                        $approvedata[$record][$key]['sourcer'] = $current_userid;                        $approvedata[$record][$key]['userid'] = $userinfo['report_userid'];                        $approvedata[$record][$key]['proxyapproval'] = getProxyApproval($report_userid);                        $approvedata[$record][$key]['flowid'] = $node;                        $approvedata[$record][$key]['decideapproval'] = $decideapprovals[$node];                        $approvedata[$record][$key]['nextflowid'] = checknextflowid($approvalflowdata['route'],$node);                        $approvedata[$record][$key]['finished'] = 'false';                        $approvedata[$record][$key]['guid'] = $guid;                        $approvedata[$record][$key]['reply'] = "Approvaling";                        $approvedata[$record][$key]['amount'] = $amount;                        $approvedata[$record][$key]['approvalinfo'] = $approvalinfo;                        $approvedata[$record][$key]['approvalflows'] = $approvalflow_info->id;                        $approvalcenterdata[$record][$key]['tabid'] = $tabid;                        $approvalcenterdata[$record][$key]['record'] = $record;                        $approvalcenterdata[$record][$key]['sourcer'] = $current_userid;                        $approvalcenterdata[$record][$key]['finished'] = 'false';                        $approvalcenterdata[$record][$key]['finishapprover']='';                        $approvalcenterdata[$record][$key]['finishapprovaldatetime']='';                        $approvalcenterdata[$record][$key]['guid'] = $guid;                        $approvalcenterdata[$record][$key]['amount'] = $amount;                        $approvalcenterdata[$record][$key]['approver'] = '';                        $approvalcenterdata[$record][$key]['pendingapprover'] = $userinfo['report_userid'];                        $approvalcenterdata[$record][$key]['flowid'] = $node;                        $approvalcenterdata[$record][$key]['lastapprovaldatetime'] = '';                        $approvalcenterdata[$record][$key]['approvalstatus'] = '1';                        $approvalcenterdata[$record][$key]['approvalcentersstatus'] = 'Approvaling';                        $approvalcenterdata[$record][$key]['customapprovalflow'] = 'approvalflows';                    }                    else if ($worknode == '000001' )                    {                        $optionalapproval = $userinfo['optionalapproval'];                        $approvedata[$record][$key]['tabid'] = $tabid;                        $approvedata[$record][$key]['record'] = $record;                        $approvedata[$record][$key]['from_userid'] = XN_Profile::$VIEWER;                        $approvedata[$record][$key]['sourcer'] = $current_userid;                        $approvedata[$record][$key]['userid'] = $optionalapproval;                        $approvedata[$record][$key]['proxyapproval'] = getProxyApproval($optionalapproval);                        $approvedata[$record][$key]['flowid'] = $node;                        $approvedata[$record][$key]['decideapproval'] = $decideapprovals[$node];                        $approvedata[$record][$key]['nextflowid'] = checknextflowid($approvalflowdata['route'],$node);                        $approvedata[$record][$key]['finished'] = 'false';                        $approvedata[$record][$key]['guid'] = $guid;                        $approvedata[$record][$key]['reply'] = "Approvaling";                        $approvedata[$record][$key]['amount'] = $amount;                        $approvedata[$record][$key]['approvalinfo'] = $approvalinfo;                        $approvedata[$record][$key]['approvalflows'] = $approvalflow_info->id;                        $approvalcenterdata[$record][$key]['tabid'] = $tabid;                        $approvalcenterdata[$record][$key]['record'] = $record;                        $approvalcenterdata[$record][$key]['sourcer'] = $current_userid;                        $approvalcenterdata[$record][$key]['finished'] = 'false';                        $approvalcenterdata[$record][$key]['finishapprover']='';                        $approvalcenterdata[$record][$key]['finishapprovaldatetime']='';                        $approvalcenterdata[$record][$key]['guid'] = $guid;                        $approvalcenterdata[$record][$key]['amount'] = $amount;                        $approvalcenterdata[$record][$key]['approver'] = '';                        $approvalcenterdata[$record][$key]['pendingapprover'] = $optionalapproval;                        $approvalcenterdata[$record][$key]['flowid'] = $node;                        $approvalcenterdata[$record][$key]['lastapprovaldatetime'] = '';                        $approvalcenterdata[$record][$key]['approvalstatus'] = '1';                        $approvalcenterdata[$record][$key]['approvalcentersstatus'] = 'Approvaling';                        $approvalcenterdata[$record][$key]['customapprovalflow'] = 'approvalflows';                    }                    else if ($worknode == '000002' )                    {                        $leadership = $userinfo['leadership'];;                        if (is_array($leadership))                        {                            foreach($leadership as $leadership_info)                            {                                $approvedata[$record][$key]['tabid'] = $tabid;                                $approvedata[$record][$key]['record'] = $record;                                $approvedata[$record][$key]['from_userid'] = XN_Profile::$VIEWER;                                $approvedata[$record][$key]['sourcer'] = $current_userid;                                $approvedata[$record][$key]['userid'] = $leadership_info;                                $approvedata[$record][$key]['proxyapproval'] = getProxyApproval($leadership_info);                                $approvedata[$record][$key]['flowid'] = $node;                                $approvedata[$record][$key]['decideapproval'] = $decideapprovals[$node];                                $approvedata[$record][$key]['nextflowid'] = checknextflowid($approvalflowdata['route'],$node);                                $approvedata[$record][$key]['finished'] = 'false';                                $approvedata[$record][$key]['guid'] = $guid;                                $approvedata[$record][$key]['reply'] = "Approvaling";                                $approvedata[$record][$key]['amount'] = $amount;                                $approvedata[$record][$key]['approvalinfo'] = $approvalinfo;                                $approvedata[$record][$key]['approvalflows'] = $approvalflow_info->id;                                $approvalcenterdata[$record][$key]['tabid'] = $tabid;                                $approvalcenterdata[$record][$key]['record'] = $record;                                $approvalcenterdata[$record][$key]['sourcer'] = $current_userid;                                $approvalcenterdata[$record][$key]['finished'] = 'false';                                $approvalcenterdata[$record][$key]['finishapprover']='';                                $approvalcenterdata[$record][$key]['finishapprovaldatetime']='';                                $approvalcenterdata[$record][$key]['guid'] = $guid;                                $approvalcenterdata[$record][$key]['amount'] = $amount;                                $approvalcenterdata[$record][$key]['approver'] = '';                                $approvalcenterdata[$record][$key]['pendingapprover'] = $leadership_info;                                $approvalcenterdata[$record][$key]['flowid'] = $node;                                $approvalcenterdata[$record][$key]['lastapprovaldatetime'] = '';                                $approvalcenterdata[$record][$key]['approvalstatus'] = '1';                                $approvalcenterdata[$record][$key]['approvalcentersstatus'] = 'Approvaling';                                $approvalcenterdata[$record][$key]['customapprovalflow'] = 'approvalflows';                            }                        }                        else                        {                            $approvedata[$record][$key]['tabid'] = $tabid;                            $approvedata[$record][$key]['record'] = $record;                            $approvedata[$record][$key]['from_userid'] = XN_Profile::$VIEWER;                            $approvedata[$record][$key]['sourcer'] = $current_userid;                            $approvedata[$record][$key]['userid'] = $leadership;                            $approvedata[$record][$key]['proxyapproval'] = getProxyApproval($leadership);                            $approvedata[$record][$key]['flowid'] = $node;                            $approvedata[$record][$key]['decideapproval'] = $decideapprovals[$node];                            $approvedata[$record][$key]['nextflowid'] = checknextflowid($approvalflowdata['route'],$node);                            $approvedata[$record][$key]['finished'] = 'false';                            $approvedata[$record][$key]['guid'] = $guid;                            $approvedata[$record][$key]['reply'] = "Approvaling";                            $approvedata[$record][$key]['amount'] = $amount;                            $approvedata[$record][$key]['approvalinfo'] = $approvalinfo;                            $approvedata[$record][$key]['approvalflows'] = $approvalflow_info->id;                            $approvalcenterdata[$record][$key]['tabid'] = $tabid;                            $approvalcenterdata[$record][$key]['record'] = $record;                            $approvalcenterdata[$record][$key]['sourcer'] = $current_userid;                            $approvalcenterdata[$record][$key]['finished'] = 'false';                            $approvalcenterdata[$record][$key]['finishapprover']='';                            $approvalcenterdata[$record][$key]['finishapprovaldatetime']='';                            $approvalcenterdata[$record][$key]['guid'] = $guid;                            $approvalcenterdata[$record][$key]['amount'] = $amount;                            $approvalcenterdata[$record][$key]['approver'] = '';                            $approvalcenterdata[$record][$key]['pendingapprover'] = $leadership;                            $approvalcenterdata[$record][$key]['flowid'] = $node;                            $approvalcenterdata[$record][$key]['lastapprovaldatetime'] = '';                            $approvalcenterdata[$record][$key]['approvalstatus'] = '1';                            $approvalcenterdata[$record][$key]['approvalcentersstatus'] = 'Approvaling';                            $approvalcenterdata[$record][$key]['customapprovalflow'] = 'approvalflows';                        }                    }                    else if ($worknode == '000003' )                    {                        $mainleadership = $userinfo['mainleadership'];                        $approvedata[$record][$key]['tabid'] = $tabid;                        $approvedata[$record][$key]['record'] = $record;                        $approvedata[$record][$key]['from_userid'] = XN_Profile::$VIEWER;                        $approvedata[$record][$key]['sourcer'] = $current_userid;                        $approvedata[$record][$key]['userid'] = $mainleadership;                        $approvedata[$record][$key]['proxyapproval'] = getProxyApproval($mainleadership);                        $approvedata[$record][$key]['flowid'] = $node;                        $approvedata[$record][$key]['decideapproval'] = $decideapprovals[$node];                        $approvedata[$record][$key]['nextflowid'] = checknextflowid($approvalflowdata['route'],$node);                        $approvedata[$record][$key]['finished'] = 'false';                        $approvedata[$record][$key]['guid'] = $guid;                        $approvedata[$record][$key]['reply'] = "Approvaling";                        $approvedata[$record][$key]['amount'] = $amount;                        $approvedata[$record][$key]['approvalinfo'] = $approvalinfo;                        $approvedata[$record][$key]['approvalflows'] = $approvalflow_info->id;                        $approvalcenterdata[$record][$key]['tabid'] = $tabid;                        $approvalcenterdata[$record][$key]['record'] = $record;                        $approvalcenterdata[$record][$key]['sourcer'] = $current_userid;                        $approvalcenterdata[$record][$key]['finished'] = 'false';                        $approvalcenterdata[$record][$key]['finishapprover']='';                        $approvalcenterdata[$record][$key]['finishapprovaldatetime']='';                        $approvalcenterdata[$record][$key]['guid'] = $guid;                        $approvalcenterdata[$record][$key]['amount'] = $amount;                        $approvalcenterdata[$record][$key]['approver'] = '';                        $approvalcenterdata[$record][$key]['pendingapprover'] = $mainleadership;                        $approvalcenterdata[$record][$key]['flowid'] = $node;                        $approvalcenterdata[$record][$key]['lastapprovaldatetime'] = '';                        $approvalcenterdata[$record][$key]['approvalstatus'] = '1';                        $approvalcenterdata[$record][$key]['approvalcentersstatus'] = 'Approvaling';                        $approvalcenterdata[$record][$key]['customapprovalflow'] = 'approvalflows';                    }                    else                    {                        $approvedata[$record][$key]['tabid'] = $tabid;                        $approvedata[$record][$key]['record'] = $record;                        $approvedata[$record][$key]['from_userid'] = $current_userid;                        $approvedata[$record][$key]['sourcer'] = $current_userid;                        $approvedata[$record][$key]['userid'] = $worknode;                        $approvedata[$record][$key]['proxyapproval'] = getProxyApproval($worknode);                        $approvedata[$record][$key]['flowid'] = $node;                        $approvedata[$record][$key]['decideapproval'] = $decideapprovals[$node];                        $approvedata[$record][$key]['nextflowid'] = checknextflowid($approvalflowdata['route'],$node);                        $approvedata[$record][$key]['finished'] = 'false';                        $approvedata[$record][$key]['guid'] = $guid;                        $approvedata[$record][$key]['reply'] = "Approvaling";                        $approvedata[$record][$key]['amount'] = $amount;                        $approvedata[$record][$key]['approvalinfo'] = $approvalinfo;                        $approvedata[$record][$key]['approvalflows'] = $approvalflow_info->id;                        $approvalcenterdata[$record][$key]['tabid'] = $tabid;                        $approvalcenterdata[$record][$key]['record'] = $record;                        $approvalcenterdata[$record][$key]['sourcer'] = $current_userid;                        $approvalcenterdata[$record][$key]['finished'] = 'false';                        $approvalcenterdata[$record][$key]['finishapprover']='';                        $approvalcenterdata[$record][$key]['finishapprovaldatetime']='';                        $approvalcenterdata[$record][$key]['guid'] = $guid;                        $approvalcenterdata[$record][$key]['amount'] = $amount;                        $approvalcenterdata[$record][$key]['approver'] = '';                        $approvalcenterdata[$record][$key]['pendingapprover'] = $worknode;                        $approvalcenterdata[$record][$key]['flowid'] = $node;                        $approvalcenterdata[$record][$key]['lastapprovaldatetime'] = '';                        $approvalcenterdata[$record][$key]['approvalstatus'] = '1';                        $approvalcenterdata[$record][$key]['approvalcentersstatus'] = 'Approvaling';                        $approvalcenterdata[$record][$key]['customapprovalflow'] = 'approvalflows';                    }                    $key++;                }            }            if(count($approvedata)){                foreach($approvedata as $record=>$datas){                    foreach($datas as $key=>$data){                        $newcontent=XN_Content::create("approvals","",false);                        foreach($data as $fieldname=>$val){                            $newcontent->my->$fieldname=$val;                            $newcontent->my->deleted='0';                            $newcontent->my->createnew='0';                        }                        $newcontents[]=$newcontent;                    }                }                XN_Content::batchsave($newcontents,"approvals");            }            $centerDatas=array();            if(count($approvalcenterdata)){                foreach($approvalcenterdata as $record=>$datas){                    foreach($datas as $key=>$data){                        $newcontent=XN_Content::create("approvalcenters","",false);                        foreach($data as $fieldname=>$val){                            $newcontent->my->$fieldname=$val;                            $newcontent->my->deleted='0';                            $newcontent->my->createnew='0';                        }                        $centerDatas[]=$newcontent;                    }                }                XN_Content::batchsave($centerDatas,"approvalcenters");            }            foreach($loadcontents as $loadcontent){                $record=$loadcontent->id;                $approver = (array)($loadcontent->my->approver);                $userid=$approvedata[$record]['userid'];                if(!in_array($userid,$approver))                {                    $approver[] = $userid;                    $loadcontent->my->approver = $approver;                }                $loadcontent->my->approvalstatus = 1;                $status = strtolower($formodule).'status';                $loadcontent->my->$status = 'Approvaling';                $loadcontent->my->submitapprovaldatetime = date("Y-m-d H:i");                $loadcontent->save(strtolower($formodule));            }            XN_Content::batchsave($loadcontents,strtolower($formodule));        }    }}function getmassNodes($approvalflowdata,$amounts,$records,$guid,$userinfos,$flowid=null){    $approvals = XN_Query::create ( 'Content' )        ->tag ( 'approvals' )        ->filter ( 'type', 'eic', 'approvals' )        ->filter ( 'my.guid', '=', $guid )        ->filter ( 'my.record', 'in', $records )        ->execute ();    $approval_userids = array();    foreach($approvals as $approval_info)    {        $approval_userids[$approval_info->my->record] = $approval_info->my->userid;    }    return getmassApprovalNodes($approvalflowdata,$amounts,$approval_userids,$userinfos,$flowid);}function getmassApprovalNodes($approvalflowdata,$amounts,$approval_userids,$userinfos,$flowid=null){    if ($flowid==null)    {        $flowid = $approvalflowdata['beginnode'];    }    $arr = array();    foreach ($approvalflowdata['route'] as $route)    {        if ($route[1] == $flowid)        {            $id = $route[2];            $condition = $route[3];            $nodeamount = floatval($route[4]);            foreach ($approvalflowdata['worknode'] as $worknode)            {                if ($worknode[0] == $id && $condition == "" && $nodeamount == "")                {                    if (checkmassNodes($worknode[2],$approval_userids,$userinfos))                    {                        if (checknextflowid($approvalflowdata['route'],$id) != "-1")                        {                            $result = getmassApprovalNodes($approvalflowdata,$amounts,$approval_userids,$userinfos,$id);                            $arr = $result + $arr;                        }                    }                    else                    {                        $arr[$id] = $worknode[2];                    }                }                else if($worknode[0] == $id)                {                    //echo '_______['.$id.']__________'.$nodeamount.'____'.$amount.'______'.$condition.'_______';                    if ($condition == "=" && $nodeamount == $amount)                    {                        if (checkmassNodes($worknode[2],$approval_userids,$userinfos))                        {                            if (checknextflowid($approvalflowdata['route'],$id) != "-1")                            {                                $result = getmassApprovalNodes($approvalflowdata,$amount,$approval_userids,$userinfos,$id);                                $arr = $result + $arr;                            }                        }                        else                        {                            $arr[$id] = $worknode[2];                        }                    }                    else if ($condition == "<" && $amount < $nodeamount  )                    {                        if (checkmassNodes($worknode[2],$approval_userids,$userinfos))                        {                            if (checknextflowid($approvalflowdata['route'],$id) != "-1")                            {                                $result = getmassApprovalNodes($approvalflowdata,$amount,$approval_userids,$userinfos,$id);                                $arr = $result + $arr;                            }                        }                        else                        {                            $arr[$id] = $worknode[2];                        }                    }                    else if ($condition == "<=" && $amount <= $nodeamount )                    {                        if (checkmassNodes($worknode[2],$approval_userids,$userinfos))                        {                            if (checknextflowid($approvalflowdata['route'],$id) != "-1")                            {                                $result = getmassApprovalNodes($approvalflowdata,$amount,$approval_userids,$userinfos,$id);                                $arr = $result + $arr;                            }                        }                        else                        {                            $arr[$id] = $worknode[2];                        }                    }                    else if ($condition == ">" && $amount > $nodeamount  )                    {                        if (checkmassNodes($worknode[2],$approval_userids,$userinfos))                        {                            if (checknextflowid($approvalflowdata['route'],$id) != "-1")                            {                                $result = getmassApprovalNodes($approvalflowdata,$amount,$approval_userids,$userinfos,$id);                                $arr = $result + $arr;                            }                        }                        else                        {                            $arr[$id] = $worknode[2];                        }                    }                    else if ($condition == ">=" && $amount >= $nodeamount )                    {                        if (checkmassNodes($worknode[2],$approval_userids,$userinfos))                        {                            if (checknextflowid($approvalflowdata['route'],$id) != "-1")                            {                                $result = getmassApprovalNodes($approvalflowdata,$amount,$approval_userids,$userinfos,$id);                                $arr = $result + $arr;                            }                        }                        else                        {                            $arr[$id] = $worknode[2];                        }                    }                }            }        }    }    return $arr;}function checkmassNodes($worknode,$approval_userids,$userinfos){    foreach($userinfos as $record=>$userinfo){        $approval_userid=$approval_userids[$record];        $approval_userid=(array)$approval_userid;        if ($worknode == '000000' )        {            $userid = $userinfo['report_userid'];            if (in_array($userid,$approval_userid) && $userid != "" ) return true;        }        else if ($worknode == '000001' )        {            $userid = $userinfo['optionalapproval'];            if (in_array($userid,$approval_userid) && $userid != "" ) return true;        }        else if ($worknode == '000002' )        {            $userid = $userinfo['leadership'];            if (in_array($userid,$approval_userid)&& $userid != "" ) return true;        }        else if ($worknode == '000003' )        {            $userid = $userinfo['mainleadership'];            if (in_array($userid,$approval_userid) && $userid != "" ) return true;        }        else        {            if (in_array($worknode,$approval_userid)) return true;        }        return false;    }}function refresh_approval($profileid) {	if (isset($_SESSION['supplierid']) && $_SESSION['supplierid'] != "" && isset($profileid) && $profileid != "")	{		$supplierid = $_SESSION['supplierid'];	   	$supplier_modules = XN_Query::create("Content")->tag("supplier_modules_".$supplierid)	   						   ->filter("type", "eic", "supplier_modules")	   						   ->filter("my.deleted", "=", "0")							   ->filter("my.status", "=", "0")							   ->filter("my.modulename", "=", "审批")	   						   ->filter("my.supplierid", "=", $supplierid) 	   						   ->end(1)	   						   ->execute();	   	if (count($supplier_modules) > 0)		{			$supplier_module_info = $supplier_modules[0];		    $tabid = $supplier_module_info->id;			$query = XN_Query::create ( 'Content' )				->tag ( 'approvals' )				->filter ( 'type', 'eic', 'approvals' )				->filter ( 'my.finished', '=', 'false' )				->filter ( XN_Filter::any(XN_Filter( 'my.userid', '=', $profileid),XN_Filter( 'my.proxyapproval', '=', $profileid)))				->filter ( 'my.deleted', '=', '0' ) 				->begin(0)				->end(1);			$approvals = $query->execute();			$noofrows = $query->getTotalCount(); 			$modules_users = XN_Query::create("Content")->tag("supplier_modules_users_".$profileid)								   ->filter("type", "eic", "supplier_modules_users")								   ->filter("my.deleted", "=", "0")								   ->filter("my.supplierid", "=", $supplierid)								   ->filter("my.profileid", "=", $profileid)								   ->filter("my.record", "=", $tabid)								   ->end(-1)								   ->execute();			if (count($modules_users) > 0)			{				$modules_user_info = $modules_users[0];				$untreated = $modules_user_info->my->untreated;				if (intval($untreated) != intval($noofrows))				{			   		$modules_user_info->my->untreated = intval($noofrows);			   		$modules_user_info->save("supplier_modules_users,supplier_modules_users_".$supplierid.",supplier_modules_users_".$profileid);				}			}			else			{				$newcontent = XN_Content::create("supplier_modules_users", "", false);				$newcontent->my->untreated   = $noofrows;				$newcontent->my->processed   = '0';				$newcontent->my->lasttime   =  date("Y-m-d H:i"); 				$newcontent->my->record  = $tabid;				$newcontent->my->profileid  = $profileid;				$newcontent->my->supplierid   = $supplierid;				$newcontent->my->deleted      = "0";				$newcontent->save("supplier_modules_users,supplier_modules_users_".$supplierid.",supplier_modules_users_".$profileid);			}		} 	} }?>