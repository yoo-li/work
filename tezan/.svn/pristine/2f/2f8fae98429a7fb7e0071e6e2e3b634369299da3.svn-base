<?phpfunction gettransfersteps($recordid, $formodule,$customapprovalflow="approvalflows"){    $focus = XN_Content::load($recordid, 'approvals');    $record = $focus->my->record;    $guid = $focus->my->guid;    $tabid = $focus->my->tabid;    $flowid = $focus->my->flowid;    $steps = array();	global $custom_approval_flow;	$custom_approval_flow = $customapprovalflow;	if ($customapprovalflow != "approvalflows")	{        $approvalflows = XN_Query::create('Content')            ->tag($customapprovalflow)            ->filter('type', 'eic', $customapprovalflow)            ->filter('my.approvalflowsstatus', '=', '1')            ->filter('my.deleted', '=', '0')            ->filter('my.customapprovalflowtabid', '=', $tabid)			->end(1)            ->execute();	}	else	{        $approvalflows = XN_Query::create('Content')            ->tag('approvalflows')            ->filter('type', 'eic', 'approvalflows')            ->filter('my.approvalflowsstatus', '=', '1')            ->filter('my.deleted', '=', '0')            ->filter('my.tabid', '=', $tabid)			->end(1)            ->execute();	}     $approvalflowdata = array();    if (count($approvalflows) > 0)    {        $approvalflow_info = $approvalflows[0];        $flowdata = $approvalflow_info->my->flowdata;        $amountfieldname = $approvalflow_info->my->fieldname;        $approvalinfo = $approvalflow_info->my->description;        $xml = new DOMDocument();        $xml->loadXML($flowdata);        $routedata = array();        $routes = $xml->getElementsByTagName("Route");        foreach ($routes as $route)        {            $id = $route->getAttribute("ID");            $fromelementid = $route->getAttribute("FromElementID");            $amount = $route->getAttribute("Amount");            $condition = $route->getAttribute("Condition");            $toelementid = $route->getAttribute("ToElementID");            $routedata[] = array($id, $fromelementid, $toelementid, $condition, floatval($amount));        }        $approvalflowdata['route'] = $routedata;        $worknodedata = array();        $decideapprovals = array();        $worknodes = $xml->getElementsByTagName("WorkNode");        foreach ($worknodes as $worknode)        {            $id = $worknode->getAttribute("ID");            $name = $worknode->getAttribute("Name");            $nodetype = $worknode->getAttribute("NodeType");            $decideapproval = $worknode->getAttribute("DecideApproval");            $decideapprovals[$id] = $decideapproval;            $worknodedata[] = array($id, $name, $nodetype);        }        $approvalflowdata['worknode'] = $worknodedata;        $beginnodes = $xml->getElementsByTagName("BeginNode");        foreach ($beginnodes as $beginnode)        {            $id = $beginnode->getAttribute("ID");            $approvalflowdata['beginnode'] = $id;        }        // print_r($approvalflowdata);        //echo '<br><br>';        if (count($approvalflowdata) > 0)        {            $loadcontent = XN_Content::load($record, strtolower($formodule));            $amount = 0;            if ($amountfieldname != "" && $loadcontent->my->$amountfieldname != "")            {                $amount = floatval($loadcontent->my->$amountfieldname);            }            $profileid = $loadcontent->author;            $optionalapproval = $loadcontent->my->optionalapproval;						$step_info = array();			$step_info["id"] = "author";			$step_info["data"]["status"] = '0';		    $username = getUserNameByProfile($profileid); 		    $label = '<b>'.$username.'</b>【创建人】';		    $label .= "<br>".date("m-d H:i",strtotime($loadcontent->published))."创建";		    $step_info["name"] = $label;  			$approvalflowdata['submitapprovaldatetime'] = $loadcontent->my->submitapprovaldatetime;            $childnodes = getnextnode($approvalflowdata, $amount, $profileid, $optionalapproval, $loadcontent, $guid); 		    if (count($childnodes) > 0)		    { 		        $step_info["children"] = array($childnodes);		    }             return $step_info;        }    }    else    {        throw new XN_Exception("没有审批流程");    }}function getnextnode($approvalflowdata, $amount, $profileid, $optionalapproval, $loadcontent, $guid, $flowid = null){    $step_info = array();	global $custom_approval_flow;    $report_userid = getUserProposalByProfileId($profileid);    $leadership = getLeadership($profileid,$custom_approval_flow);    $mainleadership = getMainLeadership($profileid,$custom_approval_flow);    $nodes = getTransfersNodes($approvalflowdata, $amount, $flowid);    $childnodes = array();    foreach ($nodes as $node => $worknode)    {        if ($worknode == '000000')        {            $childnodes[] = getnextnode($approvalflowdata, $amount, $report_userid, $optionalapproval, $loadcontent, $guid, $node);        }        else if ($worknode == '000004')        {            $childnodes[] = getnextnode($approvalflowdata, $amount, $profileid, $optionalapproval, $loadcontent, $guid, $node);        }        else if ($worknode == '000001')        {            $childnodes[] = getnextnode($approvalflowdata, $amount, $optionalapproval, $optionalapproval, $loadcontent, $guid, $node);        }        else if ($worknode == '000002')        {            if (is_array($leadership))            {                foreach ($leadership as $leadership_info)                {                    $childnodes[] = getnextnode($approvalflowdata, $amount, $leadership_info, $optionalapproval, $loadcontent, $guid, $node);                }            }            else            {                $childnodes[] = getnextnode($approvalflowdata, $amount, $leadership, $optionalapproval, $loadcontent, $guid, $node);            }        }        else if ($worknode == '000003')        {            $childnodes[] = getnextnode($approvalflowdata, $amount, $mainleadership, $optionalapproval, $loadcontent, $guid, $node);        }        else        {            $childnodes[] = getnextnode($approvalflowdata, $amount, $worknode, $optionalapproval, $loadcontent, $guid, $node);        }    }    $step_info["id"] = $profileid;    $username = getUserNameByProfile($profileid);   /* if ($loadcontent->author == $profileid)    {        $label = '<b>'.$username.'</b>【提交人】';        $label .= "<br>".date("m-d H:i",strtotime($loadcontent->published))."创建";    }    else    {*/        $label = '<b>'.$username.'</b>';        $approvals = XN_Query::create('Content')->tag('approvals')            ->filter('type', 'eic', 'approvals')            ->filter('my.deleted', '=', '0')            ->filter('my.record', '=', $loadcontent->id)            ->filter('my.guid', '=', $guid)            ->filter('my.userid', '=', $profileid)            ->end(1)            ->execute();        if (count($approvals) > 0)        {            $approval_info = $approvals[0];            if ($approval_info->my->finished == 'true')            {                $label .= '【已审】';                $difftime = strdifftime($approval_info->published,$approval_info->my->submitapprovalreplydatetime);                $label .= "<br>".date("m-d H:i",strtotime($approval_info->my->submitapprovalreplydatetime))."审批【".$difftime."】";                $step_info["data"]["status"] = '1';            }            else            {                $label .= '【待审】';                $difftime = strdifftime($approval_info->published);                $label .= "<br>".date("m-d H:i",strtotime($approval_info->published))."提交【".$difftime."】";                $step_info["data"]["status"] = '2';            }        }        else        { 			$submitapprovaldatetime = $approvalflowdata['submitapprovaldatetime'];			$label .= "【提交人】<br>".date("m-d H:i",strtotime($submitapprovaldatetime))."提交审批";            $step_info["data"]["status"] = '0';        }        // $label .= "<br>2016-04-07 12:00 提交";   // }    $step_info["name"] = $label;    if (count($childnodes) > 0)    {        $step_info["children"] = $childnodes;    }    return $step_info;}//时间转换函数function strdifftime($datetime,$difftime="now"){    $time     = strtotime($datetime);    $swaptime = strtotime($difftime) - $time;    if ($swaptime > 5184000)    {        return "2月";    }    else if ($swaptime > 5092000)    {        return "1月";    }    else if ($swaptime > 1296000)    {        return "半月";    }    else if ($swaptime > 864000)    {        return "10天";    }    else if ($swaptime > 259200)    {        return "3天";    }    else if ($swaptime > 172800)    {        return "天";    }    else if ($swaptime > 86400)    {        return "昨天";    }    else if ($swaptime > 43200)    {        return "12小时";    }    else if ($swaptime > 21600)    {        return "6小时";    }    else if ($swaptime > 10800)    {        return "3小时";    }    else if ($swaptime > 7200)    {        return "2小时";    }    else if ($swaptime > 3600)    {        return "1小时";    }    else if ($swaptime > 1800)    {        return "30分钟";    }    else if ($swaptime > 900)    {        return "15分钟";    }    else if ($swaptime > 600)    {        return "10分钟";    }    else if ($swaptime > 300)    {        return "5分钟";    }    else if ($swaptime > 180)    {        return "3分钟";    }    else if ($swaptime > 120)    {        return "2分钟";    }    else if ($swaptime > 60)    {        return "1分钟";    }    else    {        return "1分钟";    }}function getTransfersNodes($approvalflowdata, $amount, $flowid = null){    if ($flowid == null)    {        $flowid = $approvalflowdata['beginnode'];    }    $arr = array();    foreach ($approvalflowdata['route'] as $route)    {        if ($route[1] == $flowid)        {            $id = $route[2];            $condition = $route[3];            $nodeamount = floatval($route[4]);            foreach ($approvalflowdata['worknode'] as $worknode)            {                if ($worknode[0] == $id && $condition == "" && $nodeamount == "")                {                    $arr[$id] = $worknode[2];                }                else if ($worknode[0] == $id)                {                    if ($condition == "=" && $nodeamount == $amount)                    {                        $arr[$id] = $worknode[2];                    }                    else if ($condition == "<" && $amount < $nodeamount)                    {                        $arr[$id] = $worknode[2];                    }                    else if ($condition == "<=" && $amount <= $nodeamount)                    {                        $arr[$id] = $worknode[2];                    }                    else if ($condition == ">" && $amount > $nodeamount)                    {                        $arr[$id] = $worknode[2];                    }                    else if ($condition == ">=" && $amount >= $nodeamount)                    {                        $arr[$id] = $worknode[2];                    }                }            }        }    }    return $arr;}?>