<?phpglobal $copyrights;$program=$copyrights['program'];if($program=='tezan')require_once('modules/Mall_Public/config.func.php');elseif($program=='ma')require_once('modules/Ma_Public/config.func.php');elseif($program=='yiche')require_once('modules/Dev_Public/config.func.php');else require_once('modules/Public/config.func.php');function approval_physicalstore_agree($record) { 		$physicalstoreid = $record;		$loadcontent =  XN_Content::load($record,"supplier_physicalstores",4); 		$profileid  = $loadcontent->my->profileid;		$supplierid = $loadcontent->my->supplierid;		$storename = $loadcontent->my->storename;		 		$supplier_physicalstores = XN_Query::create ( 'Content' ) ->tag('supplier_physicalstoreprofiles')		    ->filter ( 'type', 'eic', 'supplier_physicalstoreprofiles') 			->filter ( 'my.supplierid', '=',$supplierid)			->filter ( 'my.profileid', '=',$profileid)		    ->filter ( 'my.deleted', '=', '0' )			->end(1)		    ->execute ();		if (count($supplier_physicalstores) == 0)		{	        $newcontent = XN_Content::create('supplier_physicalstoreprofiles', '', false);	        $newcontent->my->deleted = '0';	        $newcontent->my->profileid = $profileid;	        $newcontent->my->supplierid = $supplierid;	        $newcontent->my->physicalstoreid = $physicalstoreid;			$newcontent->my->storeprofileid = $profileid; 			$newcontent->my->assistantprofileid = $profileid; 	        $newcontent->save("supplier_physicalstoreprofiles,supplier_physicalstoreprofiles_" . $profileid. ",supplier_physicalstoreprofiles_" . $supplierid); 		}		else		{			$supplier_physicalstore_info = $supplier_physicalstores[0];	        $supplier_physicalstore_info->my->physicalstoreid = $physicalstoreid;			$supplier_physicalstore_info->my->storeprofileid = $profileid; 			$supplier_physicalstore_info->my->assistantprofileid = $profileid; 	        $supplier_physicalstore_info->save("supplier_physicalstoreprofiles,supplier_physicalstoreprofiles_" . $profileid. ",supplier_physicalstoreprofiles_" . $supplierid); 		}		$supplier_physicalstoreassistants = XN_Query::create ( 'Content' ) ->tag('supplier_physicalstoreassistants')		    ->filter ( 'type', 'eic', 'supplier_physicalstoreassistants') 			->filter ( 'my.supplierid', '=',$supplierid)			->filter ( 'my.profileid', '=',$profileid)		    ->filter ( 'my.deleted', '=', '0' )			->end(1)		    ->execute ();		if (count($supplier_physicalstoreassistants) == 0)		{	        $newcontent = XN_Content::create('supplier_physicalstoreassistants', '', false);	        $newcontent->my->deleted = '0';	        $newcontent->my->profileid = $profileid;	        $newcontent->my->supplierid = $supplierid;	        $newcontent->my->physicalstoreid = $physicalstoreid;			$newcontent->my->bonusrate = '0';  	        $newcontent->save("supplier_physicalstoreassistants,supplier_physicalstoreassistants_" . $profileid. ",supplier_physicalstoreassistants_" . $supplierid); 		} 		$supplier_wxsettings = XN_Query::create ( 'MainContent' ) ->tag('supplier_wxsettings')			->filter ( 'type', 'eic', 'supplier_wxsettings')			->filter ( 'my.deleted', '=', '0' )			->filter ( 'my.supplierid', '=' ,$supplierid)			->end(1)			->execute();		if (count($supplier_wxsettings) > 0)		{			$supplier_wxsetting_info = $supplier_wxsettings[0];			$appid = $supplier_wxsetting_info->my->appid;			require_once (XN_INCLUDE_PREFIX."/XN/Message.php");  			$message = '恭喜您，荣幸成为【'.$storename.'】的店主。';			XN_Message::sendmessage($profileid,$message,$appid); 		}			loop_physicalstore($profileid,$supplierid,$physicalstoreid,$profileid); }function loop_physicalstore($profileid,$supplierid,$physicalstoreid,$storeprofileid){ 	$supplier_profiles = XN_Query::create ( 'Content' ) 	    ->filter ( 'type', 'eic', 'supplier_profile') 		->filter ( 'my.supplierid', '=',$supplierid)		->filter ( 'my.onelevelsourcer', '=',$profileid)	    ->filter ( 'my.deleted', '=', '0' )		->end(-1)	    ->execute ();	if (count($supplier_profiles) > 0)	{		$profileids = array();		foreach($supplier_profiles as $supplier_profile_info)		{			$profileids[] = $supplier_profile_info->my->profileid;		}		$supplier_physicalstoreprofiles = XN_Query::create ( 'Content' ) 		    ->filter ( 'type', 'eic', 'supplier_physicalstoreprofiles') 			->filter ( 'my.supplierid', '=',$supplierid)			->filter ( 'my.profileid', 'in',$profileids)		    ->filter ( 'my.deleted', '=', '0' )			->end(-1)		    ->execute ();		if (count($supplier_physicalstoreprofiles) == 0)		{			foreach($profileids as $item_info)			{				$supplier_physicalstores = XN_Query::create ( 'Content' ) ->tag('supplier_physicalstores')				    ->filter ( 'type', 'eic', 'supplier_physicalstores') 					->filter ( 'my.supplierid', '=',$supplierid)					->filter ( 'my.profileid', '=',$item_info)				    ->filter ( 'my.deleted', '=', '0' )					->end(1)				    ->execute ();			    if (count ($supplier_physicalstores) == 0)				{			        $newcontent = XN_Content::create('supplier_physicalstoreprofiles', '', false);			        $newcontent->my->deleted = '0';			        $newcontent->my->profileid = $item_info;			        $newcontent->my->supplierid = $supplierid;			        $newcontent->my->physicalstoreid = $physicalstoreid;					$newcontent->my->storeprofileid = $storeprofileid; 					$newcontent->my->assistantprofileid = $storeprofileid; 			        $newcontent->save("supplier_physicalstoreprofiles,supplier_physicalstoreprofiles_" . $item_info. ",supplier_physicalstoreprofiles_" . $supplierid);	 				loop_physicalstore($item_info,$supplierid,$physicalstoreid,$storeprofileid);				}  			}		}		else		{			$modifys = array();			foreach($supplier_physicalstoreprofiles as $supplier_physicalstoreprofile_info)			{ 				    $loopprofileid =  $supplier_physicalstoreprofile_info->my->profileid;				 					$supplier_physicalstores = XN_Query::create ( 'Content' ) ->tag('supplier_physicalstores')					    ->filter ( 'type', 'eic', 'supplier_physicalstores') 						->filter ( 'my.supplierid', '=',$supplierid)						->filter ( 'my.profileid', '=',$loopprofileid)					    ->filter ( 'my.deleted', '=', '0' )						->end(1)					    ->execute ();				    if (count ($supplier_physicalstores) == 0)					{				        $supplier_physicalstoreprofile_info->my->physicalstoreid = $physicalstoreid;						$supplier_physicalstoreprofile_info->my->storeprofileid = $storeprofileid; 						$supplier_physicalstoreprofile_info->my->assistantprofileid = $storeprofileid; 				        $supplier_physicalstoreprofile_info->save("supplier_physicalstoreprofiles,supplier_physicalstoreprofiles_" . $loopprofileid. ",supplier_physicalstoreprofiles_" . $supplierid);					    loop_physicalstore($loopprofileid,$supplierid,$physicalstoreid,$storeprofileid);					}  					$modifys[] = $loopprofileid;			}			foreach($profileids as $item_info)			{				if (!in_array($item_info,$modifys))				{					$supplier_physicalstores = XN_Query::create ( 'Content' ) ->tag('supplier_physicalstores')					    ->filter ( 'type', 'eic', 'supplier_physicalstores') 						->filter ( 'my.supplierid', '=',$supplierid)						->filter ( 'my.profileid', '=',$item_info)					    ->filter ( 'my.deleted', '=', '0' )						->end(1)					    ->execute ();				    if (count ($supplier_physicalstores) == 0)					{				        $newcontent = XN_Content::create('supplier_physicalstoreprofiles', '', false);				        $newcontent->my->deleted = '0';				        $newcontent->my->profileid = $item_info;				        $newcontent->my->supplierid = $supplierid;				        $newcontent->my->physicalstoreid = $physicalstoreid;						$newcontent->my->storeprofileid = $storeprofileid; 						$newcontent->my->assistantprofileid = $storeprofileid; 				        $newcontent->save("supplier_physicalstoreprofiles,supplier_physicalstoreprofiles_" . $item_info. ",supplier_physicalstoreprofiles_" . $supplierid);						loop_physicalstore($item_info,$supplierid,$physicalstoreid,$storeprofileid);					}				} 			}		}		 	}}?>